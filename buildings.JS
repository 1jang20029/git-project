let buildingsMap;

// ê±´ë¬¼ ë§ˆì»¤/ì¸í¬ìœˆë„ìš° ë°°ì—´
let buildingMarkers = [];
let buildingInfoWindows = [];

// ì‹œì„¤ ë§ˆì»¤/ì¸í¬ìœˆë„ìš° ë°°ì—´
let facilityMarkers = [];
let facilityInfoWindows = [];

/**
 * í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
 *  - ì§€ë„ ë Œë”ë§
 *  - ê±´ë¬¼ ëª©ë¡(API: GET /api/buildings) ë¡œë“œ ë° ë§ˆì»¤ ì¶”ê°€
 *  - ì‹œì„¤ ëª©ë¡(API: GET /api/facilities) ë¡œë“œ ë° ë§ˆì»¤ ì¶”ê°€
 *  - ê° ì¹´ë“œì— í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
 */
async function initBuildingsPage() {
  initializeNaverMap();
  await Promise.all([
    loadBuildingData(),
    loadFacilitiesData()
  ]);
  attachBuildingActions();
  attachFacilityActions();
}

/**
 * ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ)
 */
function initializeNaverMap() {
  if (typeof naver === 'undefined' || !naver.maps) {
    console.error('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨');
    return;
  }

  const mapContainer = document.getElementById('buildingsMap');
  if (!mapContainer) return;

  const yeonsung = new naver.maps.LatLng(37.39661657434427, 126.90772437800818);
  const mapOptions = {
    center: yeonsung,
    zoom: 16,
    minZoom: 14,
    maxZoom: 19,
    zoomControl: false,
    logoControl: false,
    mapDataControl: false,
    scaleControl: false,
  };
  buildingsMap = new naver.maps.Map(mapContainer, mapOptions);

  // ì§€ë„ í™•ëŒ€/ì¶•ì†Œ/ë¦¬ì…‹/ë‚´ìœ„ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('buildings-zoom-in').addEventListener('click', () => {
    if (buildingsMap) buildingsMap.setZoom(buildingsMap.getZoom() + 1);
  });
  document.getElementById('buildings-zoom-out').addEventListener('click', () => {
    if (buildingsMap) buildingsMap.setZoom(buildingsMap.getZoom() - 1);
  });
  document.getElementById('buildings-reset').addEventListener('click', () => {
    if (buildingsMap) {
      buildingsMap.setCenter(yeonsung);
      buildingsMap.setZoom(16);
    }
  });
  document.getElementById('buildings-track-user').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userPos = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
        new naver.maps.Marker({
          position: userPos,
          map: buildingsMap,
          icon: {
            content:
              '<div style="background:#3b82f6;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
            anchor: new naver.maps.Point(10, 10),
          },
        });
        buildingsMap.setCenter(userPos);
        buildingsMap.setZoom(17);
      },
      (err) => {
        console.error(err);
        alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    );
  });
}

/**
 * ê±´ë¬¼ ë°ì´í„° ë¡œë“œ
 *  - GET /api/buildings
 *  - renderBuildingCards(), addBuildingMarkers() í˜¸ì¶œ
 */
async function loadBuildingData() {
  try {
    const res = await fetch('/api/buildings');
    if (!res.ok) throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
    const buildings = await res.json();

    renderBuildingCards(buildings);
    addBuildingMarkers(buildings);
  } catch (error) {
    console.error('ê±´ë¬¼ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    renderBuildingCards([]);
  }
}

/**
 * ê±´ë¬¼ ì¹´ë“œ ë Œë”ë§
 *  - #buildingGrid ë‚´ë¶€ì— ê±´ë¬¼ë³„ ì¹´ë“œ ìƒì„±
 *  - data-id ì†ì„±ì— ê±´ë¬¼ idë¥¼ ì €ì¥
 */
function renderBuildingCards(buildings) {
  const grid = document.getElementById('buildingGrid');
  if (!grid) return;
  grid.innerHTML = '';

  buildings.forEach((b) => {
    const card = document.createElement('div');
    card.className = 'building-card';
    card.setAttribute('data-id', b.id);
    card.innerHTML = `
      <h3 class="building-name">${b.name}</h3>
      <p class="building-desc">${b.address || b.description || ''}</p>
      <div class="building-actions">
        <button class="btn btn-primary" data-action="viewOnMap" data-id="${b.id}">ğŸ“ ì§€ë„ì—ì„œ ë³´ê¸°</button>
        <button class="btn btn-outline" data-action="getDirections" data-id="${b.id}">ğŸ§­ ê¸¸ì°¾ê¸°</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

/**
 * ê±´ë¬¼ ë§ˆì»¤ ì¶”ê°€
 *  - buildingsMap ìœ„ì— ë§ˆì»¤ ìƒì„±
 *  - í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš°ë¡œ ìƒì„¸ ì •ë³´ í‘œì‹œ
 */
function addBuildingMarkers(buildings) {
  if (!buildingsMap) return;
  buildingMarkers.forEach((m) => m.setMap(null));
  buildingInfoWindows.forEach((iw) => iw.close());
  buildingMarkers = [];
  buildingInfoWindows = [];

  buildings.forEach((b) => {
    if (!b.latitude || !b.longitude) return;
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(b.latitude, b.longitude),
      map: buildingsMap,
      title: String(b.id), // idë¥¼ ë¬¸ìì—´ë¡œ ì„¤ì •
    });

    const infoWindow = new naver.maps.InfoWindow({
      content: `
        <div style="padding: 10px; background: #1e293b; color: white; border-radius: 8px; border: 1px solid #3b82f6;">
          <strong style="color: #3b82f6;">${b.name}</strong><br>
          <span style="color: #94a3b8;">${b.address || ''}</span>
        </div>
      `,
      backgroundColor: 'transparent',
      borderWidth: 0,
      anchorSize: new naver.maps.Size(0, 0),
    });

    naver.maps.Event.addListener(marker, 'click', () => {
      buildingInfoWindows.forEach((iw) => iw.close());
      facilityInfoWindows.forEach((iw) => iw.close());
      infoWindow.open(buildingsMap, marker);
    });

    buildingMarkers.push(marker);
    buildingInfoWindows.push(infoWindow);
  });
}

/**
 * ê±´ë¬¼ ì¹´ë“œ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
 */
function attachBuildingActions() {
  const grid = document.getElementById('buildingGrid');
  if (!grid) return;

  grid.addEventListener('click', (event) => {
    const btn = event.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');

    if (action === 'viewOnMap') {
      focusOnBuildingMarker(id);
    } else if (action === 'getDirections') {
      alert('ê±´ë¬¼ ê¸¸ì°¾ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤');
    }
  });
}

/**
 * íŠ¹ì • ê±´ë¬¼ ë§ˆì»¤ë¡œ í¬ì»¤ìŠ¤ ì´ë™
 */
function focusOnBuildingMarker(buildingId) {
  const idx = buildingMarkers.findIndex(m => m.getTitle() === buildingId);
  if (idx >= 0) {
    const marker = buildingMarkers[idx];
    const pos = marker.getPosition();
    buildingsMap.setCenter(pos);
    buildingsMap.setZoom(18);
    buildingInfoWindows[idx].open(buildingsMap, marker);
  }
}

/**
 * ì‹œì„¤ ë°ì´í„° ë¡œë“œ
 *  - GET /api/facilities
 *  - renderFacilityCards(), addFacilityMarkers() í˜¸ì¶œ
 */
async function loadFacilitiesData() {
  try {
    const res = await fetch('/api/facilities');
    if (!res.ok) throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
    const facilities = await res.json();

    renderFacilityCards(facilities);
    addFacilityMarkers(facilities);
    // ê° ì‹œì„¤ë³„ ì²« ë²ˆì§¸ ì‚¬ì§„ì„ ì¸ë„¤ì¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    facilities.forEach(f => loadFacilityThumbnail(f.id));
  } catch (error) {
    console.error('ì‹œì„¤ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    renderFacilityCards([]);
  }
}

/**
 * ì‹œì„¤ ì¹´ë“œ ë Œë”ë§
 *  - #facilitiesGrid ë‚´ë¶€ì— ì‹œì„¤ë³„ ì¹´ë“œ ìƒì„±
 *  - data-id ì†ì„±ì— ì‹œì„¤ id ì €ì¥
 *  - ì´ë¯¸ì§€ íƒœê·¸(.facility-thumbnail)ëŠ” ì¼ë‹¨ ë¹ˆ ìƒíƒœ
 */
function renderFacilityCards(facilities) {
  const grid = document.getElementById('facilitiesGrid');
  if (!grid) return;
  grid.innerHTML = '';

  facilities.forEach((f) => {
    const card = document.createElement('div');
    card.className = 'facility-card';
    card.setAttribute('data-id', f.id);
    card.innerHTML = `
      <img
        class="facility-thumbnail"
        id="fac-thumb-${f.id}"
        src=""
        alt="ì‹œì„¤ ì´ë¯¸ì§€"
        onerror="this.style.display='none'"
      />
      <h3 class="facility-name">${f.name}</h3>
      <p class="facility-desc">${f.address || ''}</p>
      <div class="facility-actions">
        <button class="btn btn-primary" data-action="viewFacOnMap" data-id="${f.id}">ğŸ“ ì§€ë„ì—ì„œ ë³´ê¸°</button>
        <button class="btn btn-outline" data-action="viewPhotos" data-id="${f.id}">ğŸ–¼ï¸ ì‚¬ì§„ ë³´ê¸°</button>
        <button class="btn btn-outline" data-action="getFacDirections" data-id="${f.id}">ğŸ§­ ê¸¸ì°¾ê¸°</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

/**
 * ê° ì‹œì„¤ì˜ ì²« ë²ˆì§¸ ì‚¬ì§„ì„ ì¸ë„¤ì¼ë¡œ ë¡œë“œ
 *  - GET /api/facilities/:id/photos
 *  - ë°›ì•„ì˜¨ ë°°ì—´ì˜ ì²« ë²ˆì§¸ urlì„ <img id="fac-thumb-{id}">ì— srcë¡œ ì„¤ì •
 */
async function loadFacilityThumbnail(facilityId) {
  try {
    const res = await fetch(`/api/facilities/${facilityId}/photos`);
    if (!res.ok) throw new Error('ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨');
    const photos = await res.json();
    if (photos.length > 0) {
      const thumbEl = document.getElementById(`fac-thumb-${facilityId}`);
      if (thumbEl) thumbEl.src = photos[0].url;
    }
  } catch (error) {
    console.error(`ì‹œì„¤ ${facilityId} ì¸ë„¤ì¼ ë¡œë“œ ì‹¤íŒ¨:`, error);
  }
}

/**
 * ì‹œì„¤ ë§ˆì»¤ ì¶”ê°€
 *  - ì‹œì„¤ë§ˆë‹¤ ì´ˆë¡ìƒ‰ ë§ˆì»¤ (diff icon) ìƒì„±
 *  - í´ë¦­ ì‹œ í•´ë‹¹ ì‹œì„¤ ì¸í¬ìœˆë„ìš° ì—´ê¸°
 */
function addFacilityMarkers(facilities) {
  if (!buildingsMap) return;
  facilityMarkers.forEach((m) => m.setMap(null));
  facilityInfoWindows.forEach((iw) => iw.close());
  facilityMarkers = [];
  facilityInfoWindows = [];

  facilities.forEach((f) => {
    if (!f.latitude || !f.longitude) return;
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(f.latitude, f.longitude),
      map: buildingsMap,
      icon: {
        content:
          '<div style="background:#10b981;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
        anchor: new naver.maps.Point(10, 10),
      },
      title: String(f.id),
    });

    const infoWindow = new naver.maps.InfoWindow({
      content: `
        <div style="padding: 10px; background: #1e293b; color: white; border-radius: 8px; border: 1px solid #10b981;">
          <strong style="color: #10b981;">${f.name}</strong><br>
          <span style="color: #94a3b8;">${f.address || ''}</span>
        </div>
      `,
      backgroundColor: 'transparent',
      borderWidth: 0,
      anchorSize: new naver.maps.Size(0, 0),
    });

    naver.maps.Event.addListener(marker, 'click', () => {
      buildingInfoWindows.forEach((iw) => iw.close());
      facilityInfoWindows.forEach((iw) => iw.close());
      infoWindow.open(buildingsMap, marker);
    });

    facilityMarkers.push(marker);
    facilityInfoWindows.push(infoWindow);
  });
}

/**
 * ì‹œì„¤ ì¹´ë“œ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
 */
function attachFacilityActions() {
  const grid = document.getElementById('facilitiesGrid');
  if (!grid) return;

  grid.addEventListener('click', (event) => {
    const btn = event.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');

    if (action === 'viewFacOnMap') {
      focusOnFacilityMarker(id);
    } else if (action === 'viewPhotos') {
      openFacilityPhotoModal(id);
    } else if (action === 'getFacDirections') {
      alert('ì‹œì„¤ ê¸¸ì°¾ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤');
    }
  });
}

/**
 * íŠ¹ì • ì‹œì„¤ ë§ˆì»¤ë¡œ í¬ì»¤ìŠ¤ ì´ë™
 */
function focusOnFacilityMarker(facilityId) {
  const idx = facilityMarkers.findIndex(m => m.getTitle() === facilityId);
  if (idx >= 0) {
    const marker = facilityMarkers[idx];
    const pos = marker.getPosition();
    buildingsMap.setCenter(pos);
    buildingsMap.setZoom(18);
    facilityInfoWindows[idx].open(buildingsMap, marker);
  }
}

/**
 * ì‹œì„¤ ì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
 *  - GET /api/facilities/:id/photos
 *  - ëª¨ë“  ì‚¬ì§„ URLì„ ëª¨ë‹¬ ì•ˆì— <img> í˜•íƒœë¡œ ë³´ì—¬ì¤Œ
 */
async function openFacilityPhotoModal(facilityId) {
  const modal = document.getElementById('photoModal');
  const container = document.getElementById('modalImagesContainer');
  container.innerHTML = ''; // ì´ˆê¸°í™”

  try {
    const res = await fetch(`/api/facilities/${facilityId}/photos`);
    if (!res.ok) throw new Error('ì‚¬ì§„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜');
    const photos = await res.json();

    if (photos.length === 0) {
      container.innerHTML = `<p style="color:#94a3b8; text-align:center;">ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    } else {
      photos.forEach((p) => {
        const img = document.createElement('img');
        img.src = p.url;
        img.alt = p.description || '';
        container.appendChild(img);
      });
    }
  } catch (error) {
    console.error('ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨:', error);
    container.innerHTML = `<p style="color:#ef4444; text-align:center;">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
  }

  // ëª¨ë‹¬ í‘œì‹œ
  modal.style.display = 'block';

  // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('modalClose').onclick = () => {
    modal.style.display = 'none';
  };

  // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  window.onclick = (evt) => {
    if (evt.target === modal) {
      modal.style.display = 'none';
    }
  };
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ ì—°ê²°
window.initBuildingsPage = initBuildingsPage;
