<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°œì¸ì •ë³´ ìˆ˜ì • - ì—°ì„±ëŒ€í•™êµ ìº í¼ìŠ¤ ê°€ì´ë“œ</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3836f1efa74c42d67fb12b4c2dda5aa9"></script> 
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
        }
        
        header {
            background-color: #c62917;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-button {
            display: flex;
            align-items: center;
            gap: 4px;
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        
        .page-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .content-section {
            padding: 16px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        
        .profile-form {
            display: flex;
            flex-direction: column;
        }
        
        /* ìˆ˜ì •ëœ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .profile-image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 16px;
            position: relative;
        }
        
        /* ìˆ˜ì •ëœ í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .profile-image-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin-bottom: 16px;
        }
        
        .profile-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            overflow: hidden;
        }
        
        /* í—¤ë”ì— ìˆëŠ” í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .header-profile {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-left: auto; /* ìš°ì¸¡ìœ¼ë¡œ ì •ë ¬ */
        }
        
        /* ìˆ˜ì •ëœ í¸ì§‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - í”„ë¡œí•„ê³¼ ê²¹ì¹˜ë„ë¡ */
        .edit-image-button {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            background-color: #c62917;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            background-color: white;
        }
        
        .form-readonly {
            background-color: #f9f9f9;
            color: #777;
        }
        
        .divider {
            height: 1px;
            background-color: #eee;
            margin: 20px 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .save-button {
            flex: 1;
            padding: 14px;
            background-color: #c62917;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .cancel-button {
            flex: 1;
            padding: 14px;
            background-color: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
        }
        
        .section-divider {
            padding: 8px 16px;
            background-color: #f9f9f9;
            font-weight: bold;
            color: #555;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .error-message {
            color: #c62917;
            font-size: 13px;
            margin-top: 4px;
            display: none;
        }
        
        .has-error .form-input {
            border-color: #c62917;
        }
        
        .has-error .error-message {
            display: block;
        }
        
        .notice-text {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ê°œì„  */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .modal-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-section-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 16px 0;
            text-align: center;
        }
        
        .upload-button {
            display: block;
            width: 100%;
            padding: 14px 0;
            background-color: #c62917;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .preview-container {
            margin-top: 16px;
            display: none;
            text-align: center;
        }
        
        .preview-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 16px;
            display: block;
        }
        
        .apply-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #c62917;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        .image-option {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .image-option:hover {
            border-color: #c62917;
            background-color: #fff8f8;
        }
        
        .emoji-image {
            font-size: 36px;
        }
        
        .modal-footer {
            padding: 16px;
            text-align: center;
            background-color: #f5f5f5;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="back-button" onclick="goToBack()">
                <span>â†</span>
                <span>ë’¤ë¡œ</span>
            </div>
            <div class="page-title">ê°œì¸ì •ë³´ ìˆ˜ì •</div>
            <div class="header-profile" id="headerProfileImage">
                <!-- ì—¬ê¸°ì— í—¤ë” í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            </div>
        </header>
        
        <div class="profile-image-section">
            <div class="profile-image-container">
                <div class="profile-image" id="profileImage">
                    ğŸ‘¨â€ğŸ“
                </div>
                <div class="edit-image-button" onclick="changeProfileImage()">+</div>
            </div>
        </div>
        
        <form class="profile-form" id="profileEditForm" onsubmit="return saveProfile(event)">
            <div class="section-divider">ê¸°ë³¸ ì •ë³´</div>
            
            <div class="content-section">
                <div class="form-group">
                    <label class="form-label" for="studentId">í•™ë²ˆ</label>
                    <input type="text" id="studentId" class="form-input form-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="name">ì´ë¦„</label>
                    <input type="text" id="name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="department">í•™ê³¼</label>
                    <select id="department" class="form-select" required>
                        <option value="computerScience">ì»´í“¨í„°ì •ë³´í•™ê³¼</option>
                        <option value="business">ê²½ì˜í•™ê³¼</option>
                        <option value="nursing">ê°„í˜¸í•™ê³¼</option>
                        <option value="engineering">ê³µí•™ê³„ì—´</option>
                        <option value="arts">ì˜ˆìˆ ê³„ì—´</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="grade">í•™ë…„</label>
                    <select id="grade" class="form-select" required>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                    </select>
                </div>
            </div>
            
            <div class="section-divider">ê³„ì • ì •ë³´</div>
            
            <div class="content-section">
                <div class="form-group">
                    <label class="form-label" for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" class="form-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" required>
                    <div class="error-message">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="phone">ì „í™”ë²ˆí˜¸</label>
                    <input type="tel" id="phone" class="form-input" placeholder="010-0000-0000" required>
                    <div class="error-message">ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>
            
            <div class="section-divider">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
            
            <div class="content-section">
                <div class="form-group">
                    <label class="form-label" for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="currentPassword" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    <div class="notice-text">ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
                    <div class="error-message">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="cancel-button" onclick="goToBack()">ì·¨ì†Œ</button>
                    <button type="submit" class="save-button">ì €ì¥</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
            checkLoginStatus();
            
            // í¼ ì…ë ¥ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setupFormValidation();
        });
        
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
        function checkLoginStatus() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const currentUser = localStorage.getItem('currentLoggedInUser');
            
            if (!currentUser) {
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }
            
            // í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
            loadProfileInfo(currentUser);
        }
        
        // í”„ë¡œí•„ ì •ë³´ ë¡œë“œ - ìˆ˜ì •ëœ ë²„ì „
        function loadProfileInfo(userId) {
            // ì‹¤ì œ ë¡œê·¸ì¸í•œ ê³„ì • IDë¥¼ í•™ë²ˆìœ¼ë¡œ í‘œì‹œ
            document.getElementById('studentId').value = userId;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const name = localStorage.getItem(`user_${userId}_name`) || 'ì—°ì„±ëŒ€í•™êµ';
            const department = localStorage.getItem(`user_${userId}_department`) || 'business';
            const grade = localStorage.getItem(`user_${userId}_grade`) || '2';
            const email = localStorage.getItem(`user_${userId}_email`) || 'test@test';
            const phone = localStorage.getItem(`user_${userId}_phone`) || '010-3402-3447';
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ê´€ë ¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const profileImageType = localStorage.getItem(`user_${userId}_profileImageType`) || 'emoji';
            const profileImage = localStorage.getItem(`user_${userId}_profileImage`) || 'ğŸ‘¨â€ğŸ“';
            const customProfileImage = localStorage.getItem(`user_${userId}_customProfileImage`);
            
            // í¼ì— ì •ë³´ ì„¤ì •
            document.getElementById('name').value = name;
            document.getElementById('department').value = department;
            document.getElementById('grade').value = grade;
            document.getElementById('email').value = email;
            document.getElementById('phone').value = phone;
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì • - ìˆ˜ì •ëœ ë°©ì‹
            const profileImageElement = document.getElementById('profileImage');
            const headerProfileElement = document.getElementById('headerProfileImage');
            
            if (profileImageType === 'emoji') {
                profileImageElement.innerHTML = profileImage;
                headerProfileElement.innerHTML = profileImage;
            } else if (profileImageType === 'image') {
                profileImageElement.innerHTML = `<img src="${profileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                headerProfileElement.innerHTML = `<img src="${profileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else if (profileImage === 'custom' && customProfileImage) {
                // ì—¬ê¸°ì„œ custom í…ìŠ¤íŠ¸ ëŒ€ì‹  ì‹¤ì œ ì´ë¯¸ì§€ í‘œì‹œ
                profileImageElement.innerHTML = `<img src="${customProfileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                headerProfileElement.innerHTML = `<img src="${customProfileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                profileImageElement.innerHTML = 'ğŸ‘¨â€ğŸ“';
                headerProfileElement.innerHTML = 'ğŸ‘¨â€ğŸ“';
            }
        }
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ í•¨ìˆ˜ - UI ê°œì„  ë²„ì „
        function changeProfileImage() {
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜µì…˜ ë°°ì—´
            const profileImages = [
                { type: 'emoji', value: 'ğŸ‘¨â€ğŸ“' },
                { type: 'emoji', value: 'ğŸ‘©â€ğŸ“' },
                { type: 'emoji', value: 'ğŸ‘¨â€ğŸ’¼' },
                { type: 'emoji', value: 'ğŸ‘©â€ğŸ’¼' },
                { type: 'emoji', value: 'ğŸ‘¨â€ğŸ«' },
                { type: 'emoji', value: 'ğŸ‘©â€ğŸ«' },
                { type: 'emoji', value: 'ğŸ‘¨â€ğŸ”¬' },
                { type: 'emoji', value: 'ğŸ‘©â€ğŸ”¬' },
                { type: 'emoji', value: 'ğŸ‘¨â€ğŸ’»' },
                { type: 'emoji', value: 'ğŸ‘©â€ğŸ’»' }
            ];
            
            // ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ìƒì„±
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal-container';
            modalContainer.id = 'profileImageModal';
            
            // ëª¨ë‹¬ ë‚´ìš©
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // ëª¨ë‹¬ í—¤ë”
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            modalHeader.innerHTML = '<h3 class="modal-title">í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ</h3>';
            
            // ì‚¬ì§„ ì—…ë¡œë“œ ì„¹ì…˜
            const uploadSection = document.createElement('div');
            uploadSection.className = 'modal-section';
            
            // ì—…ë¡œë“œ ë²„íŠ¼
            const uploadLabel = document.createElement('label');
            uploadLabel.className = 'upload-button';
            uploadLabel.htmlFor = 'imageUpload';
            uploadLabel.textContent = 'ì‚¬ì§„ ì—…ë¡œë“œ';
            
            const uploadInput = document.createElement('input');
            uploadInput.type = 'file';
            uploadInput.id = 'imageUpload';
            uploadInput.accept = 'image/*';
            uploadInput.style.display = 'none';
            uploadInput.addEventListener('change', handleImageUpload);
            
            const previewContainer = document.createElement('div');
            previewContainer.className = 'preview-container';
            previewContainer.id = 'previewContainer';
            
            uploadSection.appendChild(uploadLabel);
            uploadSection.appendChild(uploadInput);
            uploadSection.appendChild(previewContainer);
            
            // ê¸°ë³¸ ì´ë¯¸ì§€ ì„¹ì…˜
            const emojiSection = document.createElement('div');
            emojiSection.className = 'modal-section';
            
            const emojiTitle = document.createElement('h4');
            emojiTitle.className = 'modal-section-title';
            emojiTitle.textContent = 'ê¸°ë³¸ ì´ë¯¸ì§€';
            
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'image-grid';
            
            // ì´ëª¨í‹°ì½˜ ì˜µì…˜ ì¶”ê°€
            profileImages.forEach(image => {
                const option = document.createElement('div');
                option.className = 'image-option';
                option.onclick = () => selectProfileImage(image.value, 'emoji');
                
                const emoji = document.createElement('div');
                emoji.className = 'emoji-image';
                emoji.textContent = image.value;
                
                option.appendChild(emoji);
                emojiGrid.appendChild(option);
            });
            
            emojiSection.appendChild(emojiTitle);
            emojiSection.appendChild(emojiGrid);
            
            // ëª¨ë‹¬ í‘¸í„° (ë‹«ê¸° ë²„íŠ¼)
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';
            modalFooter.textContent = 'ë‹«ê¸°';
            modalFooter.onclick = closeProfileImageModal;
            
            // ëª¨ë‹¬ ë‚´ìš© ì¡°ë¦½
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(uploadSection);
            modalContent.appendChild(emojiSection);
            modalContent.appendChild(modalFooter);
            
            modalContainer.appendChild(modalContent);
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.body.appendChild(modalContainer);
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewContainer = document.getElementById('previewContainer');
                    previewContainer.innerHTML = '';
                    
                    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
                    const imagePreview = document.createElement('img');
                    imagePreview.className = 'preview-image';
                    imagePreview.src = e.target.result;
                    
                    // ì ìš© ë²„íŠ¼
                    const applyButton = document.createElement('button');
                    applyButton.className = 'apply-button';
                    applyButton.textContent = 'ì´ ì‚¬ì§„ìœ¼ë¡œ ì„¤ì •';
                    applyButton.onclick = function() {
                        uploadCustomImage(e.target.result);
                    };
                    
                    previewContainer.appendChild(imagePreview);
                    previewContainer.appendChild(applyButton);
                    previewContainer.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        }

        // ì‚¬ìš©ì ì§€ì • ì´ë¯¸ì§€ ì„¤ì • - ìˆ˜ì •ëœ ë²„ì „
        function uploadCustomImage(imageData) {
            // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            const profileImageElement = document.getElementById('profileImage');
            profileImageElement.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            // í—¤ë” í”„ë¡œí•„ ì´ë¯¸ì§€ë„ ì—…ë°ì´íŠ¸
            const headerProfileElement = document.getElementById('headerProfileImage');
            headerProfileElement.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const studentId = document.getElementById('studentId').value;
            const currentUser = localStorage.getItem('currentLoggedInUser');
            
            localStorage.setItem(`user_${currentUser}_profileImageType`, 'custom');
            localStorage.setItem(`user_${currentUser}_profileImage`, 'custom');
            localStorage.setItem(`user_${currentUser}_customProfileImage`, imageData);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeProfileImageModal();
            
            // ë¶€ëª¨ ì°½(ë©”ì¸ ì•±)ì— ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ì—¬ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            updateParentWindowProfileImage(imageData);
        }
        
        // ë¶€ëª¨ ì°½ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateParentWindowProfileImage(imageData) {
            try {
                // ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ ë©”ì¸ ì•±ì— ì•Œë¦¼
                localStorage.setItem('profileImageUpdated', 'true');
                
                // í˜¹ì‹œ ë¶€ëª¨ ì°½ì´ ìˆë‹¤ë©´ ì§ì ‘ ì ‘ê·¼
                if (window.opener && !window.opener.closed) {
                    window.opener.updateProfileImage(imageData);
                }
            } catch (e) {
                console.log('ë¶€ëª¨ ì°½ ì—…ë°ì´íŠ¸ ì‹œë„ ì¤‘ ì˜¤ë¥˜:', e);
            }
        }

        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ í•¨ìˆ˜ - ìˆ˜ì •ëœ ë²„ì „
        function selectProfileImage(image, type) {
            // ì„ íƒí•œ ì´ë¯¸ì§€ë¡œ í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½
            const profileImageElement = document.getElementById('profileImage');
            const headerProfileElement = document.getElementById('headerProfileImage');
            
            if (type === 'emoji') {
                profileImageElement.innerHTML = image;
                headerProfileElement.innerHTML = image;
            } else {
                profileImageElement.innerHTML = `<img src="${image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                headerProfileElement.innerHTML = `<img src="${image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const currentUser = localStorage.getItem('currentLoggedInUser');
            localStorage.setItem(`user_${currentUser}_profileImageType`, type);
            localStorage.setItem(`user_${currentUser}_profileImage`, image);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeProfileImageModal();
            
            // ë¶€ëª¨ ì°½ ì—…ë°ì´íŠ¸
            if (type === 'emoji') {
                updateParentWindowProfileEmoji(image);
            }
        }
        
        // ë¶€ëª¨ ì°½ì˜ ì´ëª¨ì§€ í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        function updateParentWindowProfileEmoji(emoji) {
            try {
                localStorage.setItem('profileEmojiUpdated', 'true');
                localStorage.setItem('profileEmojiValue', emoji);
                
                if (window.opener && !window.opener.closed) {
                    window.opener.updateProfileEmoji(emoji);
                }
            } catch (e) {
                console.log('ë¶€ëª¨ ì°½ ì´ëª¨ì§€ ì—…ë°ì´íŠ¸ ì‹œë„ ì¤‘ ì˜¤ë¥˜:', e);
            }
        }

        // í”„ë¡œí•„ ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        function closeProfileImageModal() {
            const modal = document.getElementById('profileImageModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // í¼ ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
        function setupFormValidation() {
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // ì´ë©”ì¼ ì…ë ¥ ê²€ì‚¬
            emailInput.addEventListener('blur', function() {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const isValid = emailRegex.test(this.value);
                validateField(this, isValid);
            });
            
            // ì „í™”ë²ˆí˜¸ ì…ë ¥ ê²€ì‚¬
            phoneInput.addEventListener('blur', function() {
                const phoneRegex = /^010-\d{4}-\d{4}$/;
                const isValid = phoneRegex.test(this.value);
                validateField(this, isValid);
            });
            
            // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¼ì¹˜ ê²€ì‚¬
            confirmPasswordInput.addEventListener('input', function() {
                const isValid = this.value === newPasswordInput.value;
                validateField(this, isValid);
            });
        }
        
        // í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ ë° ì—ëŸ¬ í‘œì‹œ
        function validateField(field, isValid) {
            const formGroup = field.parentElement;
            
            if (!isValid && field.value.trim() !== '') {
                formGroup.classList.add('has-error');
            } else {
                formGroup.classList.remove('has-error');
            }
        }

        // í”„ë¡œí•„ ì €ì¥
        function saveProfile(event) {
            event.preventDefault();
            
            // í•„ìˆ˜ ì…ë ¥ ê²€ì‚¬
            const name = document.getElementById('name').value.trim();
            const department = document.getElementById('department').value;
            const grade = document.getElementById('grade').value;
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            if (!name || !department || !grade || !email || !phone) {
                alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê²€ì‚¬
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword) {
                if (!currentPassword) {
                    alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return false;
                }
                
                // ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€ì‚¬ (ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© 8ì ì´ìƒ)
                const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
                if (!passwordRegex.test(newPassword)) {
                    alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return false;
                }
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const currentUser = localStorage.getItem('currentLoggedInUser');
            localStorage.setItem(`user_${currentUser}_name`, name);
            localStorage.setItem(`user_${currentUser}_department`, department);
            localStorage.setItem(`user_${currentUser}_grade`, grade);
            localStorage.setItem(`user_${currentUser}_email`, email);
            localStorage.setItem(`user_${currentUser}_phone`, phone);
            
            if (newPassword) {
                localStorage.setItem(`user_${currentUser}_password`, newPassword);
            }
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ìˆëŠ” ê²½ìš° ì—…ë°ì´íŠ¸ë˜ì—ˆì„ ê²ƒì„)
            const profileImageType = localStorage.getItem(`user_${currentUser}_profileImageType`) || 'emoji';
            const profileImage = localStorage.getItem(`user_${currentUser}_profileImage`) || 'ğŸ‘¨â€ğŸ“';
            const customProfileImage = localStorage.getItem(`user_${currentUser}_customProfileImage`);
            
            // ëª¨ë“  í˜ì´ì§€ì— í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ë¥¼ ì•Œë¦¬ëŠ” í”Œë˜ê·¸ ì„¤ì •
            localStorage.setItem('profileUpdated', 'true');
            
            alert('ê°œì¸ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
            goToBack();
            
            return false;
        }

        // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
        function goToBack() {
            window.history.back();
        }
    </script>
</body>
</html>