<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연성대학교 캠퍼스 내비게이션</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_CLIENT_ID"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #e1e1e1;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .status-panel {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: white;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        .building-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .building-list h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .building-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .building-item {
            background: linear-gradient(45deg, #ffecd2, #fcb69f);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .building-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .building-item h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .building-item p {
            color: #666;
            font-size: 0.9em;
        }

        .roadview-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: white;
            z-index: 1000;
            display: none;
        }

        #roadview {
            width: 100%;
            height: 100%;
        }

        .location-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .coordinates {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            #map {
                height: 400px;
            }
            
            .roadview-container {
                width: 150px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏫 연성대학교 캠퍼스 내비게이션</h1>
            <p>실시간 위치 추적과 정확한 길찾기 서비스</p>
        </div>

        <div class="control-panel">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="건물명을 입력하세요 (예: 공학1관, 도의관)">
                <button onclick="searchBuilding()" class="btn btn-primary">🔍 건물 찾기</button>
                <button onclick="startTracking()" class="btn btn-success" id="trackingBtn">📍 위치 추적 시작</button>
                <button onclick="findRoute()" class="btn btn-secondary" id="routeBtn" disabled>🛣️ 길찾기</button>
                <button onclick="toggleRoadview()" class="btn btn-secondary">👀 로드뷰</button>
            </div>
        </div>

        <div class="status-panel" id="statusPanel">
            📍 위치 추적을 시작하여 정확한 길찾기를 이용하세요
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="roadview-container" id="roadviewContainer">
                <div id="roadview"></div>
            </div>
        </div>

        <div class="location-info" id="locationInfo" style="display: none;">
            <h4>📍 현재 위치 정보</h4>
            <div class="coordinates" id="coordinatesDisplay"></div>
            <p><strong>정확도:</strong> <span id="accuracyDisplay"></span>m</p>
        </div>

        <div class="building-list">
            <h3>🏢 캠퍼스 건물 목록</h3>
            <div class="building-grid" id="buildingGrid"></div>
        </div>
    </div>

    <script>
        // 건물 데이터
        const buildingData = [
            {
                id: '공학1관',
                name: '공학1관',
                description: '공학계열 강의실, 실험실',
                image: 'https://placehold.co/80x60/gray/white?text=공학1관',
                type: 'building',
                position: { lat: 37.39632767479923, lng: 126.90699348692698 }
            },
            {
                id: '자연과학관',
                name: '자연과학관',
                description: '반려동물보건학, 반려동물산업학',
                image: 'https://placehold.co/80x60/gray/white?text=자연과학관',
                type: 'building',
                position: { lat: 37.39669466288283, lng: 126.90676716508685 }
            },
            {
                id: '식품과학관',
                name: '식품과학관',
                description: '식품영양학과, 조리실습실',
                image: 'https://placehold.co/80x60/gray/white?text=식품과학관',
                type: 'building',
                position: { lat: 37.39714809720343, lng: 126.90762208499473 }
            },
            {
                id: '도의관',
                name: '도의관',
                description: '교양 수업, 강당',
                image: 'https://placehold.co/80x60/gray/white?text=도의관',
                type: 'building',
                position: { lat: 37.39679932128769, lng: 126.90809683728425 }
            },
            {
                id: '공학2관',
                name: '공학2관',
                description: '공학계열 실습실, 연구실',
                image: 'https://placehold.co/80x60/gray/white?text=공학2관',
                type: 'building',
                position: { lat: 37.396789747114205, lng: 126.90737406929797 }
            },
            {
                id: '문화1관',
                name: '문화1관',
                description: '인문사회계열 강의실',
                image: 'https://placehold.co/80x60/gray/white?text=문화1관',
                type: 'building',
                position: { lat: 37.39576992475254, lng: 126.90812350405056 }
            },
            {
                id: '연곡문화센터',
                name: '연곡문화센터',
                description: '기숙사, 컨벤션홀, 평생교육원',
                image: 'https://placehold.co/80x60/gray/white?text=연곡문화센터',
                type: 'building',
                position: { lat: 37.398046192024914, lng: 126.90966512810492 }
            },
            {
                id: '창조관',
                name: '창조관',
                description: '학과 사무실, 강의실',
                image: 'https://placehold.co/80x60/gray/white?text=창조관',
                type: 'building',
                position: { lat: 37.39730791148064, lng: 126.91039726900274 }
            },
            {
                id: '운동장',
                name: '운동장',
                description: '체육활동, 행사장',
                image: 'https://placehold.co/80x60/gray/white?text=운동장',
                type: 'building',
                position: { lat: 37.39673944839101, lng: 126.90932224700094 }
            },
            {
                id: '농구장',
                name: '농구장',
                description: '체육활동',
                image: 'https://placehold.co/80x60/gray/white?text=농구장',
                type: 'building',
                position: { lat: 37.39667684947615, lng: 126.90994063692402 }
            },
            {
                id: '학생복지센터',
                name: '학생복지센터',
                description: '학생지원 시설',
                image: 'https://placehold.co/80x60/gray/white?text=학생복지센터',
                type: 'building',
                position: { lat: 37.3962916630711, lng: 126.90994109780426 }
            },
            {
                id: '창의교육센터',
                name: '창의교육센터',
                description: '항공서비스과 항공실습실, 카페',
                image: 'https://placehold.co/80x60/gray/white?text=창의교육센터',
                type: 'building',
                position: { lat: 37.39737971014044, lng: 126.91002449732869 }
            },
            {
                id: '문화2관',
                name: '문화2관',
                description: '문화콘텐츠계열 강의실',
                image: 'https://placehold.co/80x60/gray/white?text=문화2관',
                type: 'building',
                position: { lat: 37.396035307891026, lng: 126.90758674745014 }
            },
            {
                id: '대학본관',
                name: '대학본관',
                description: '유통물류학과, 총장실',
                image: 'https://placehold.co/80x60/gray/white?text=대학본관',
                type: 'building',
                position: { lat: 37.397467068076345, lng: 126.90938066144557 }
            },
            {
                id: '학술정보관',
                name: '학술정보관',
                description: '독서실',
                image: 'https://placehold.co/80x60/gray/white?text=학술정보관',
                type: 'building',
                position: { lat: 37.39637467129301, lng: 126.906603807587 }
            }
        ];

        // 전역 변수
        let map, roadview;
        let currentLocationMarker, destinationMarker;
        let currentPosition = null;
        let selectedBuilding = null;
        let trackingWatchId = null;
        let isTracking = false;
        let buildingMarkers = [];
        let routePolyline = null;

        // 지도 초기화
        function initMap() {
            // 네이버 지도 API 로드 확인
            if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
                console.error('네이버 지도 API가 로드되지 않았습니다.');
                updateStatus('❌ 지도 API 로드 실패. 네이버 지도 API 키를 확인해주세요.');
                // 테스트용 구글 맵으로 대체
                initGoogleMap();
                return;
            }

            const mapOptions = {
                center: new naver.maps.LatLng(37.39661657434427, 126.90772437800818),
                zoom: 17,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: naver.maps.MapTypeControlStyle.BUTTON,
                    position: naver.maps.Position.TOP_RIGHT
                },
                zoomControl: true,
                zoomControlOptions: {
                    style: naver.maps.ZoomControlStyle.LARGE,
                    position: naver.maps.Position.TOP_LEFT
                }
            };

            try {
                map = new naver.maps.Map('map', mapOptions);
                
                // 로드뷰 초기화
                roadview = new naver.maps.StreetView(document.getElementById('roadview'));

                // 건물 마커 생성
                createBuildingMarkers();
                
                // 건물 목록 생성
                createBuildingList();

                updateStatus('✅ 지도가 성공적으로 로드되었습니다. 위치 추적을 시작해주세요.');
            } catch (error) {
                console.error('지도 초기화 오류:', error);
                updateStatus('❌ 지도 초기화 실패. 대체 지도를 로드합니다.');
                initGoogleMap();
            }
        }

        // 구글 맵으로 대체 (네이버 지도 실패 시)
        function initGoogleMap() {
            document.getElementById('map').innerHTML = `
                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, %764ba2 100%); display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🗺️</div>
                    <h3 style="margin-bottom: 15px;">지도 서비스 준비 중</h3>
                    <p style="margin-bottom: 20px;">네이버 지도 API 키가 필요합니다.</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; font-size: 14px; max-width: 400px;">
                        <p><strong>해결 방법:</strong></p>
                        <p>1. 네이버 클라우드 플랫폼에서 Maps API 키 발급</p>
                        <p>2. HTML 파일의 YOUR_CLIENT_ID를 실제 키로 교체</p>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <p><strong>연성대학교 위치:</strong></p>
                        <p>위도: 37.39661657434427</p>
                        <p>경도: 126.90772437800818</p>
                    </div>
                </div>
            `;
            
            // 기본 기능은 계속 작동하도록
            createBuildingList();
            updateStatus('⚠️ 지도 API 키가 필요합니다. 건물 목록은 사용 가능합니다.');
        }

        // 건물 마커 생성
        function createBuildingMarkers() {
            if (!map || typeof naver === 'undefined') {
                console.log('지도 또는 네이버 API가 로드되지 않아 마커를 생성할 수 없습니다.');
                return;
            }

            buildingData.forEach(building => {
                try {
                    const position = new naver.maps.LatLng(building.position.lat, building.position.lng);
                    
                    const marker = new naver.maps.Marker({
                        position: position,
                        map: map,
                        title: building.name,
                        icon: {
                            content: `<div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); white-space: nowrap;">${building.name}</div>`,
                            anchor: new naver.maps.Point(0, 0)
                        }
                    });

                    // 마커 클릭 이벤트
                    naver.maps.Event.addListener(marker, 'click', () => {
                        selectBuilding(building);
                        showBuildingInfo(building, position);
                    });

                    buildingMarkers.push(marker);
                } catch (error) {
                    console.error('마커 생성 오류:', error);
                }
            });
        }

        // 건물 정보 표시
        function showBuildingInfo(building, position) {
            const infoWindow = new naver.maps.InfoWindow({
                content: `
                    <div style="padding: 15px; max-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">${building.name}</h4>
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${building.description}</p>
                        <button onclick="selectBuilding({id: '${building.id}', name: '${building.name}', position: {lat: ${building.position.lat}, lng: ${building.position.lng}}})" 
                                style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                            목적지로 설정
                        </button>
                    </div>
                `
            });

            infoWindow.open(map, position);
        }

        // 건물 목록 생성
        function createBuildingList() {
            const grid = document.getElementById('buildingGrid');
            
            buildingData.forEach(building => {
                const item = document.createElement('div');
                item.className = 'building-item';
                item.innerHTML = `
                    <h4>${building.name}</h4>
                    <p>${building.description}</p>
                `;
                
                item.addEventListener('click', () => {
                    selectBuilding(building);
                    // 지도 중심을 해당 건물로 이동
                    map.setCenter(new naver.maps.LatLng(building.position.lat, building.position.lng));
                    map.setZoom(18);
                });
                
                grid.appendChild(item);
            });
        }

        // 위치 추적 시작
        function startTracking() {
            if (isTracking) {
                stopTracking();
                return;
            }

            if (!navigator.geolocation) {
                updateStatus('❌ 이 브라우저는 위치 서비스를 지원하지 않습니다.');
                return;
            }

            updateStatus('📍 위치 정보를 가져오는 중...');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // 실시간 위치 추적
            trackingWatchId = navigator.geolocation.watchPosition(
                updateCurrentLocation,
                handleLocationError,
                options
            );

            isTracking = true;
            document.getElementById('trackingBtn').textContent = '⏹️ 추적 중지';
            document.getElementById('trackingBtn').classList.remove('btn-success');
            document.getElementById('trackingBtn').classList.add('btn-secondary');
        }

        // 위치 추적 중지
        function stopTracking() {
            if (trackingWatchId) {
                navigator.geolocation.clearWatch(trackingWatchId);
                trackingWatchId = null;
            }

            isTracking = false;
            document.getElementById('trackingBtn').textContent = '📍 위치 추적 시작';
            document.getElementById('trackingBtn').classList.remove('btn-secondary');
            document.getElementById('trackingBtn').classList.add('btn-success');
            updateStatus('위치 추적이 중지되었습니다.');
        }

        // 현재 위치 업데이트
        function updateCurrentLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            currentPosition = { lat, lng };

            // 현재 위치 마커 업데이트
            if (currentLocationMarker) {
                currentLocationMarker.setMap(null);
            }

            currentLocationMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lng),
                map: map,
                icon: {
                    content: `
                        <div style="width: 20px; height: 20px; background: #4285f4; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;">
                            <div style="width: 40px; height: 40px; background: rgba(66, 133, 244, 0.2); border-radius: 50%; position: absolute; top: -13px; left: -13px; animation: pulse 2s infinite;"></div>
                        </div>
                        <style>
                            @keyframes pulse {
                                0% { transform: scale(0.8); opacity: 1; }
                                100% { transform: scale(2); opacity: 0; }
                            }
                        </style>
                    `,
                    anchor: new naver.maps.Point(10, 10)
                }
            });

            // 위치 정보 표시
            document.getElementById('locationInfo').style.display = 'block';
            document.getElementById('coordinatesDisplay').textContent = `위도: ${lat.toFixed(8)}, 경도: ${lng.toFixed(8)}`;
            document.getElementById('accuracyDisplay').textContent = accuracy.toFixed(1);

            // 길찾기 버튼 활성화
            document.getElementById('routeBtn').disabled = false;

            updateStatus(`✅ 현재 위치가 업데이트되었습니다. (정확도: ${accuracy.toFixed(1)}m)`);

            // 지도 중심을 현재 위치로 이동 (처음에만)
            if (!map.hasCenter || map.getCenter().distanceTo(new naver.maps.LatLng(lat, lng)) > 1000) {
                map.setCenter(new naver.maps.LatLng(lat, lng));
                map.setZoom(17);
            }
        }

        // 위치 오류 처리
        function handleLocationError(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '❌ 사용자가 위치 정보 제공을 거부했습니다.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '❌ 위치 정보를 사용할 수 없습니다.';
                    break;
                case error.TIMEOUT:
                    message = '❌ 위치 정보 요청이 시간 초과되었습니다.';
                    break;
                default:
                    message = '❌ 알 수 없는 오류가 발생했습니다.';
                    break;
            }
            updateStatus(message);
        }

        // 건물 검색
        function searchBuilding() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                updateStatus('검색할 건물명을 입력해주세요.');
                return;
            }

            const building = buildingData.find(b => 
                b.name.toLowerCase().includes(query.toLowerCase()) ||
                b.description.toLowerCase().includes(query.toLowerCase())
            );

            if (building) {
                selectBuilding(building);
                map.setCenter(new naver.maps.LatLng(building.position.lat, building.position.lng));
                map.setZoom(18);
                updateStatus(`🏢 "${building.name}"을(를) 찾았습니다.`);
            } else {
                updateStatus(`❌ "${query}"에 해당하는 건물을 찾을 수 없습니다.`);
            }
        }

        // 건물 선택
        function selectBuilding(building) {
            selectedBuilding = building;

            // 목적지 마커 업데이트
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }

            destinationMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(building.position.lat, building.position.lng),
                map: map,
                icon: {
                    content: `
                        <div style="background: linear-gradient(45deg, #f093fb, #f5576c); color: white; padding: 10px 15px; border-radius: 25px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); white-space: nowrap; position: relative;">
                            🎯 ${building.name}
                            <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #f5576c;"></div>
                        </div>
                    `,
                    anchor: new naver.maps.Point(0, 0)
                }
            });

            updateStatus(`🎯 목적지: ${building.name}`);
            
            // 길찾기 버튼 활성화 (현재 위치가 있는 경우)
            if (currentPosition) {
                document.getElementById('routeBtn').disabled = false;
            }
        }

        // 길찾기
        function findRoute() {
            if (!currentPosition || !selectedBuilding) {
                updateStatus('❌ 현재 위치와 목적지가 필요합니다.');
                return;
            }

            updateStatus('🔍 최적 경로를 검색 중...');

            // 기존 경로 제거
            if (routePolyline) {
                routePolyline.setMap(null);
            }

            const start = new naver.maps.LatLng(currentPosition.lat, currentPosition.lng);
            const end = new naver.maps.LatLng(selectedBuilding.position.lat, selectedBuilding.position.lng);

            // Direction API 사용 (도보 경로)
            naver.maps.Service.route({
                start: start,
                goal: end,
                option: 'trafast' // 실시간 빠른길
            }, function(status, response) {
                if (status === naver.maps.Service.Status.ERROR) {
                    // API 실패 시 직선 경로로 대체
                    createStraightRoute(start, end);
                    return;
                }

                const route = response.result.route;
                if (route && route.trafast && route.trafast.length > 0) {
                    const path = route.trafast[0].path;
                    const polylinePath = path.map(p => new naver.maps.LatLng(p[1], p[0]));
                    
                    routePolyline = new naver.maps.Polyline({
                        map: map,
                        path: polylinePath,
                        strokeColor: '#4285f4',
                        strokeOpacity: 0.8,
                        strokeWeight: 6,
                        strokeLineCap: 'round',
                        strokeLineJoin: 'round'
                    });

                    // 경로에 맞게 지도 범위 조정
                    const bounds = new naver.maps.LatLngBounds();
                    polylinePath.forEach(point => bounds.extend(point));
                    map.fitBounds(bounds, { padding: 50 });

                    const distance = route.trafast[0].summary.distance;
                    const duration = route.trafast[0].summary.duration;
                    
                    updateStatus(`✅ 경로 안내: 거리 ${(distance/1000).toFixed(2)}km, 예상 시간 ${Math.ceil(duration/60000)}분`);
                } else {
                    createStraightRoute(start, end);
                }
            });
        }

        // 직선 경로 생성 (API 실패 시 대체)
        function createStraightRoute(start, end) {
            routePolyline = new naver.maps.Polyline({
                map: map,
                path: [start, end],
                strokeColor: '#ff6b6b',
                strokeOpacity: 0.8,
                strokeWeight: 6,
                strokeLineCap: 'round',
                strokeStyle: 'dashed'
            });

            // 지도 범위 조정
            const bounds = new naver.maps.LatLngBounds();
            bounds.extend(start);
            bounds.extend(end);
            map.fitBounds(bounds, { padding: 50 });

            const distance = start.distanceTo(end);
            updateStatus(`📍 직선 거리: ${(distance/1000).toFixed(2)}km (도보 경로)`);
        }

        // 로드뷰 토글
        function toggleRoadview() {
            const container = document.getElementById('roadviewContainer');
            
            if (container.style.display === 'none' || !container.style.display) {
                if (currentPosition) {
                    // 현재 위치의 로드뷰 표시
                    const position = new naver.maps.LatLng(currentPosition.lat, currentPosition.lng);
                    roadview.setPosition(position);
                    roadview.setPov({
                        pan: 0,
                        tilt: 0,
                        fov: 100
                    });
                    container.style.display = 'block';
                    updateStatus('🌐 로드뷰가 활성화되었습니다.');
                } else {
                    updateStatus('❌ 현재 위치가 필요합니다.');
                }
            } else {
                container.style.display = 'none';
                updateStatus('로드뷰가 비활성화되었습니다.');
            }
        }

        // 상태 업데이트
        function updateStatus(message) {
            document.getElementById('statusPanel').textContent = message;
        }

        // Enter 키 이벤트
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBuilding();
            }
        });

        // 지도 클릭 이벤트 (로드뷰 위치 변경)
        naver.maps.Event.addListener(map, 'click', function(e) {
            const container = document.getElementById('roadviewContainer');
            if (container.style.display === 'block') {
                roadview.setPosition(e.coord);
                updateStatus(`📍 로드뷰 위치: ${e.coord.lat().toFixed(6)}, ${e.coord.lng().toFixed(6)}`);
            }
        });

        // GPS 정확도 향상을 위한 추가 옵션
        function requestHighAccuracyLocation() {
            if (!navigator.geolocation) return;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    updateCurrentLocation(position);
                    updateStatus('🎯 고정밀 위치가 업데이트되었습니다.');
                },
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // 거리 계산 헬퍼 함수
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // 지구 반지름 (미터)
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // 미터 단위 거리
        }

        // 건물까지의 거리 표시
        function updateDistanceToBuilding() {
            if (!currentPosition || !selectedBuilding) return;

            const distance = calculateDistance(
                currentPosition.lat, currentPosition.lng,
                selectedBuilding.position.lat, selectedBuilding.position.lng
            );

            if (distance < 50) {
                updateStatus(`🎉 목적지 "${selectedBuilding.name}"에 도착했습니다! (${distance.toFixed(0)}m)`);
            } else if (distance < 200) {
                updateStatus(`🚶‍♂️ "${selectedBuilding.name}"까지 ${distance.toFixed(0)}m 남았습니다.`);
            }
        }

        // 실시간 거리 업데이트를 위한 위치 추적 개선
        function enhancedUpdateCurrentLocation(position) {
            updateCurrentLocation(position);
            updateDistanceToBuilding();
        }

        // 페이지 로드 시 지도 초기화
        window.onload = function() {
            console.log('페이지 로드 완료, 지도 초기화 시작...');
            
            // 네이버 지도 API 로드 확인
            if (typeof naver === 'undefined') {
                console.error('네이버 지도 API가 로드되지 않았습니다.');
                setTimeout(() => {
                    if (typeof naver === 'undefined') {
                        updateStatus('❌ 네이버 지도 API 로드 실패. API 키를 확인해주세요.');
                        initGoogleMap();
                    } else {
                        initMap();
                    }
                }, 2000);
            } else {
                initMap();
            }
            
            // 자동으로 위치 추적 시작 제안 (3초 후)
            setTimeout(() => {
                if (confirm('위치 기반 서비스를 사용하시겠습니까?\n정확한 길찾기를 위해 권장됩니다.')) {
                    startTracking();
                } else {
                    updateStatus('위치 서비스 없이 지도를 탐색할 수 있습니다.');
                }
            }, 3000);
        };

        // 화면 크기 변경 시 지도 크기 조정
        window.addEventListener('resize', function() {
            if (map) {
                map.autoResize();
            }
        });

        // 배터리 절약 모드 (백그라운드에서 추적 빈도 조절)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isTracking) {
                // 페이지가 백그라운드로 갈 때 추적 빈도 감소
                stopTracking();
                setTimeout(() => {
                    if (document.hidden) startTracking();
                }, 5000);
            }
        });

        // 오프라인 상태 감지
        window.addEventListener('online', function() {
            updateStatus('✅ 인터넷 연결이 복구되었습니다.');
        });

        window.addEventListener('offline', function() {
            updateStatus('⚠️ 인터넷 연결이 끊어졌습니다. 기본 기능만 사용 가능합니다.');
        });

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'f':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                    case 'l':
                        e.preventDefault();
                        startTracking();
                        break;
                    case 'r':
                        e.preventDefault();
                        if (currentPosition && selectedBuilding) {
                            findRoute();
                        }
                        break;
                }
            }
        });

        // 디버그 정보 (개발용)
        function showDebugInfo() {
            console.log('현재 위치:', currentPosition);
            console.log('선택된 건물:', selectedBuilding);
            console.log('추적 상태:', isTracking);
            console.log('지도 중심:', map.getCenter());
            console.log('지도 줌:', map.getZoom());
        }

        // 전역 함수로 노출 (HTML에서 호출하기 위해)
        window.selectBuilding = selectBuilding;
        window.searchBuilding = searchBuilding;
        window.startTracking = startTracking;
        window.findRoute = findRoute;
        window.toggleRoadview = toggleRoadview;
        window.showDebugInfo = showDebugInfo;

    </script>
</body>
</html>