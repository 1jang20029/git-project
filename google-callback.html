<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - 연성대학교 캠퍼스 가이드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: #c62917;
        }
        
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-option {
            margin-bottom: 30px;
        }
        
        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .social-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .google-button {
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
        }
        
        .google-button:hover {
            background-color: #f5f5f5;
        }
        
        .kakao-button {
            background-color: #FEE500;
            color: #3A1D1D;
            border: none;
        }
        
        .kakao-button:hover {
            background-color: #f4dc00;
        }
        
        .naver-button {
            background-color: #03C75A;
            color: white;
            border: none;
        }
        
        .naver-button:hover {
            background-color: #02b050;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .google-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23EA4335' d='M5.266 9.765A7.077 7.077 0 0 1 12 4.909c1.69 0 3.218.6 4.418 1.582L19.91 3C17.782 1.145 15.055 0 12 0 7.27 0 3.198 2.698 1.24 6.65l4.026 3.115Z'/%3E%3Cpath fill='%234285F4' d='M16.04 18.013c-1.09.703-2.474 1.078-4.04 1.078a7.077 7.077 0 0 1-6.723-4.823l-4.04 3.067A11.965 11.965 0 0 0 12 24c2.933 0 5.735-1.043 7.834-3l-3.793-2.987Z'/%3E%3Cpath fill='%23FBBC05' d='M5.277 14.268A7.12 7.12 0 0 1 4.909 12c0-.782.125-1.533.357-2.235L1.24 6.65A11.934 11.934 0 0 0 0 12c0 1.92.445 3.73 1.237 5.335l4.04-3.067Z'/%3E%3Cpath fill='%2334A853' d='M12 19.091c1.8 0 3.425-.572 4.756-1.642l3.794 2.987C18.654 22.069 15.576 24 12 24c-4.595 0-8.58-2.593-10.762-6.4l4.026-3.077c1.07 2.675 3.497 4.568 6.736 4.568Z'/%3E%3C/svg%3E");
        }
        
        .kakao-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 99.61 92.52'%3E%3Cpath d='M49.8 0C22.3 0 0 17.9 0 39.93c0 14.54 9.6 27.33 24.14 34.36-1.06 3.92-3.84 14.21-4.4 16.4-.68 2.73 1 2.7 2.1 1.97.87-.59 13.7-9.33 19.28-13.12 2.8.41 5.7.62 8.68.62 27.51 0 49.81-17.9 49.81-39.93S77.31 0 49.8 0Z'/%3E%3C/svg%3E");
        }
        
        .naver-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='white' d='M13.52 10.25 6.37 0H0v20h6.48V9.75L13.63 20H20V0h-6.48z'/%3E%3C/svg%3E");
        }
        
        /* 구글 Identity Services 버튼 컨테이너 */
        #google-signin-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        /* 오류 메시지 스타일 */
        .error-message {
            background-color: #fff8f8;
            border: 1px solid #ffdddd;
            color: #d63031;
            padding: 12px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 14px;
            display: none;
        }
        
        /* 알림 메시지 스타일 */
        .alert-message {
            background-color: #fff9c4;
            border: 1px solid #ffd54f;
            color: #715c00;
            padding: 12px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 14px;
            display: none;
        }
        
        /* 로딩 표시기 */
        .loading-spinner {
            display: none;
            margin: 20px auto;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4285F4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 모바일 환경 알림 */
        .mobile-alert {
            font-size: 13px;
            line-height: 1.5;
            margin-top: 15px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">연성대학교 캠퍼스 가이드</div>
        </header>
        
        <div class="login-section">
            <div class="section-title">로그인</div>
            
            <div class="login-option">
                <div class="social-buttons">
                    <!-- 구글 GSI 라이브러리 렌더링용 버튼 컨테이너 -->
                    <div id="google-signin-container"></div>
                    
                    <!-- 대체 구글 버튼 (GSI 로드 실패 시) -->
                    <a href="#" class="social-button google-button" id="fallback-google-button">
                        <div class="icon google-icon"></div>
                        구글 계정으로 로그인
                    </a>
                    
                    <a href="#" class="social-button kakao-button" onclick="handleKakaoLogin()">
                        <div class="icon kakao-icon"></div>
                        카카오 계정으로 로그인
                    </a>
                    
                    <a href="#" class="social-button naver-button" onclick="handleNaverLogin()">
                        <div class="icon naver-icon"></div>
                        네이버 계정으로 로그인
                    </a>
                </div>
            </div>
            
            <!-- 오류 메시지 표시 영역 -->
            <div class="error-message" id="error-message"></div>
            
            <!-- 알림 메시지 표시 영역 -->
            <div class="alert-message" id="alert-message"></div>
            
            <!-- 로딩 표시기 -->
            <div class="loading-spinner" id="loading-spinner"></div>
            
            <!-- 모바일 브라우저 알림 -->
            <div class="mobile-alert" id="mobile-alert">
                * 모바일 환경에서 구글 로그인 시 Chrome 또는 Safari 브라우저 사용을 권장합니다.
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            // 구글 로그인 초기화
            initGoogleAuth();
            
            // 구글 대체 버튼 클릭 이벤트
            document.getElementById('fallback-google-button').addEventListener('click', function(e) {
                e.preventDefault();
                openGoogleAuthInNewTab();
            });
            
            // 모바일 환경 감지
            if (isMobileDevice()) {
                document.getElementById('mobile-alert').style.display = 'block';
            }
        });
        
        // 구글 인증 초기화
        function initGoogleAuth() {
            // 로딩 표시
            document.getElementById('loading-spinner').style.display = 'block';
            
            // 구글 GSI 스크립트 로드
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            
            // 스크립트 로드 성공 시
            script.onload = function() {
                try {
                    // 로딩 숨김
                    document.getElementById('loading-spinner').style.display = 'none';
                    
                    // GSI 클라이언트 설정
                    window.google.accounts.id.initialize({
                        client_id: '682526101032-6fpr7h5u93gkf762m0rkoj5bo5hpgs2u.apps.googleusercontent.com',
                        callback: handleGoogleResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true
                    });
                    
                    // 버튼 렌더링
                    window.google.accounts.id.renderButton(
                        document.getElementById('google-signin-container'),
                        { 
                            type: 'standard',
                            theme: 'outline',
                            size: 'large',
                            shape: 'rectangular',
                            text: 'signin_with',
                            logo_alignment: 'left'
                        }
                    );
                    
                    // 대체 버튼 숨김
                    document.getElementById('fallback-google-button').style.display = 'none';
                    
                } catch (error) {
                    console.error('Google GSI 초기화 오류:', error);
                    // GSI 초기화 실패 시 대체 버튼 표시
                    document.getElementById('fallback-google-button').style.display = 'flex';
                    document.getElementById('google-signin-container').style.display = 'none';
                }
            };
            
            // 스크립트 로드 실패 시
            script.onerror = function() {
                console.error('Google GSI 스크립트 로드 실패');
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('fallback-google-button').style.display = 'flex';
                document.getElementById('google-signin-container').style.display = 'none';
            };
            
            // 스크립트 추가
            document.head.appendChild(script);
        }
        
        // 구글 로그인 응답 처리
        function handleGoogleResponse(response) {
            console.log('구글 로그인 응답 수신');
            
            if (response && response.credential) {
                // JWT 토큰 추출
                const credential = response.credential;
                const payload = parseJwt(credential);
                
                if (payload) {
                    // 사용자 정보 세션 저장
                    const googleId = 'google_' + payload.sub;
                    sessionStorage.setItem('temp_social_id', googleId);
                    sessionStorage.setItem('temp_social_type', 'google');
                    sessionStorage.setItem('temp_social_name', payload.name || '구글 사용자');
                    sessionStorage.setItem('temp_social_email', payload.email || '');
                    
                    // 가입 여부 확인 및 리디렉션
                    checkUserAndRedirect(googleId);
                } else {
                    showError('인증 정보를 처리할 수 없습니다.');
                }
            } else {
                showError('구글 로그인 응답이 올바르지 않습니다.');
            }
        }
        
        // JWT 토큰 파싱
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('JWT 토큰 파싱 실패:', e);
                return null;
            }
        }
        
        // 새 탭에서 구글 인증 페이지 열기 (대체 방법)
        function openGoogleAuthInNewTab() {
            // 로딩 표시
            document.getElementById('loading-spinner').style.display = 'block';
            
            // 알림 메시지 표시
            showAlert('새 창에서 구글 로그인을 진행합니다. 로그인 후 이 페이지로 돌아옵니다.');
            
            // 구글 OAuth URL 구성
            const clientId = '682526101032-6fpr7h5u93gkf762m0rkoj5bo5hpgs2u.apps.googleusercontent.com';
            const redirectUri = encodeURIComponent(window.location.origin + '/google-callback.html');
            const scope = encodeURIComponent('email profile openid');
            const responseType = 'code';
            const prompt = 'select_account';
            
            // 구글 인증 URL
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=${responseType}&prompt=${prompt}`;
            
            // 새 탭에서 열기
            window.location.href = googleAuthUrl;
        }
        
        // 카카오 로그인 처리
        function handleKakaoLogin() {
            const clientId = 'beed5990dc19ffd7ab4f2355afa70129'; // 카카오 API 키
            const redirectUri = encodeURIComponent(window.location.origin + '/kakao-callback.html');
            
            const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code`;
            
            window.location.href = kakaoAuthUrl;
        }
        
        // 네이버 로그인 처리
        function handleNaverLogin() {
            const clientId = 'YOUR_NAVER_CLIENT_ID'; // 네이버 클라이언트 ID 입력
            const redirectUri = encodeURIComponent(window.location.origin + '/naver-callback.html');
            const state = generateRandomState();
            
            // 네이버 로그인 상태 저장
            sessionStorage.setItem('naver_state', state);
            
            const naverAuthUrl = `https://nid.naver.com/oauth2.0/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}`;
            
            window.location.href = naverAuthUrl;
        }
        
        // 랜덤 상태값 생성 (CSRF 방지)
        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        
        // 사용자 확인 및 리디렉션
        function checkUserAndRedirect(userId) {
            // 로딩 표시
            document.getElementById('loading-spinner').style.display = 'block';
            
            try {
                // 등록된 사용자인지 확인
                const isRegistered = localStorage.getItem(`user_${userId}_registered`) === 'true';
                
                if (isRegistered) {
                    // 기존 사용자 로그인 처리
                    localStorage.setItem('currentLoggedInUser', userId);
                    
                    // 최초 로그인 여부 확인
                    const isFirstLogin = localStorage.getItem(`user_${userId}_first_login`) !== 'false';
                    
                    if (isFirstLogin) {
                        localStorage.setItem(`user_${userId}_first_login`, 'false');
                        
                        // 위젯 설정 페이지로 이동
                        setTimeout(function() {
                            window.location.href = "widget-settings.html";
                        }, 1000);
                    } else {
                        // 메인 페이지로 이동
                        setTimeout(function() {
                            window.location.href = "index.html";
                        }, 1000);
                    }
                } else {
                    // 신규 사용자 - 회원가입 페이지로 이동
                    setTimeout(function() {
                        window.location.href = "register.html?social=google";
                    }, 1000);
                }
            } catch (error) {
                console.error('사용자 확인 중 오류:', error);
                showError('사용자 정보를 확인하는 중 오류가 발생했습니다.');
            }
        }
        
        // 모바일 기기 확인
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // 오류 메시지 표시
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('loading-spinner').style.display = 'none';
        }
        
        // 알림 메시지 표시
        function showAlert(message) {
            const alertElement = document.getElementById('alert-message');
            alertElement.textContent = message;
            alertElement.style.display = 'block';
        }
        </script>
    </body>
</html>