// ë„¤ë¹„ê²Œì´ì…˜ ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€

// ê¸¸ì°¾ê¸° ëª¨ë‹¬ HTML 
const navigationModalHTML = `
<div id="navigation-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ê¸¸ì°¾ê¸°</h3>
            <span class="close-button" onclick="closeNavigationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="navigation-options">
                <div class="nav-option-group">
                    <label>ì°¾ëŠ” ì¥ì†Œ ìœ í˜•</label>
                    <div class="option-buttons">
                        <button id="building-option" class="option-button active" onclick="setNavigationType('building')">ê±´ë¬¼</button>
                        <button id="classroom-option" class="option-button" onclick="setNavigationType('classroom')">ê°•ì˜ì‹¤</button>
                    </div>
                </div>
                
                <!-- ê±´ë¬¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                <div id="building-selection" class="nav-input-group">
                    <label for="building-select">ê±´ë¬¼ ì„ íƒ</label>
                    <select id="building-select" class="nav-select">
                        <option value="">ê±´ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <!-- ê±´ë¬¼ ì˜µì…˜ë“¤ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ì¶”ê°€ -->
                    </select>
                </div>
                
                <!-- ê°•ì˜ì‹¤ ì…ë ¥ í¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
                <div id="classroom-input" class="nav-input-group" style="display: none;">
                    <label for="classroom-number">ê°•ì˜ì‹¤ ë²ˆí˜¸</label>
                    <input type="text" id="classroom-number" class="nav-input" placeholder="ì˜ˆ: 3-101">
                    <div class="helper-text">ê±´ë¬¼-í˜¸ìˆ˜ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê³µí•™1ê´€-101)</div>
                    
                    <!-- ìì£¼ ì°¾ëŠ” ê°•ì˜ì‹¤ ë²„íŠ¼ë“¤ -->
                    <div class="quick-classroom-buttons">
                        <div class="helper-text">ìì£¼ ì°¾ëŠ” ê°•ì˜ì‹¤:</div>
                        <div class="quick-buttons">
                            <button class="quick-button" onclick="setClassroom('ê³µí•™1ê´€-101')">ê³µí•™1ê´€-101</button>
                            <button class="quick-button" onclick="setClassroom('ë¬¸í™”1ê´€-203')">ë¬¸í™”1ê´€-203</button>
                            <button class="quick-button" onclick="setClassroom('ë„ì˜ê´€-301')">ë„ì˜ê´€-301</button>
                        </div>
                    </div>
                </div>
                
                <!-- ì¶œë°œì§€ ì„ íƒ (í˜„ì¬ ìœ„ì¹˜ ë˜ëŠ” ë‹¤ë¥¸ ê±´ë¬¼) -->
                <div class="nav-input-group">
                    <label for="start-point">ì¶œë°œì§€</label>
                    <select id="start-point" class="nav-select">
                        <option value="current">í˜„ì¬ ìœ„ì¹˜</option>
                        <!-- ì¶œë°œì§€ ì˜µì…˜ë“¤ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ì¶”ê°€ -->
                    </select>
                </div>
                
                <!-- ì´ë™ ë°©ì‹ ì„ íƒ -->
                <div class="nav-input-group">
                    <label>ì´ë™ ë°©ì‹</label>
                    <div class="option-buttons">
                        <button class="option-button active" onclick="setTransportMode('walking')">ë„ë³´</button>
                        <button class="option-button" onclick="setTransportMode('shuttle')">ì…”í‹€ë²„ìŠ¤</button>
                    </div>
                </div>
                
                <!-- ì‹œì‘ ë²„íŠ¼ -->
                <button id="start-navigation-btn" class="start-navigation" onclick="startNavigation()">ê¸¸ì°¾ê¸° ì‹œì‘</button>
            </div>
        </div>
    </div>
</div>
`;

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ í™”ë©´ HTML
const navigationGuideHTML = `
<div id="navigation-guide" class="navigation-container">
    <div class="navigation-header">
        <button class="back-button" onclick="cancelNavigation()">
            <span>&larr;</span> ë’¤ë¡œ
        </button>
        <h3 id="navigation-title">ê¸¸ì°¾ê¸°</h3>
        <button class="close-button" onclick="cancelNavigation()">
            <span>&times;</span>
        </button>
    </div>
    
    <div class="navigation-map" id="navigation-map">
        <!-- ë„¤ì´ë²„ ì§€ë„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    
    <div class="navigation-info">
        <div class="destination-info">
            <div class="dest-icon">ğŸ«</div>
            <div class="dest-details">
                <div id="dest-name" class="dest-name">ëª©ì ì§€ ì´ë¦„</div>
                <div id="dest-desc" class="dest-desc">ëª©ì ì§€ ì •ë³´</div>
            </div>
        </div>
        
        <div class="route-info">
            <div class="route-summary">
                <div class="route-distance">
                    <span class="info-label">ì´ ê±°ë¦¬</span>
                    <span id="total-distance" class="info-value">0m</span>
                </div>
                <div class="route-time">
                    <span class="info-label">ì˜ˆìƒ ì†Œìš”ì‹œê°„</span>
                    <span id="total-time" class="info-value">0ë¶„</span>
                </div>
            </div>
            
            <div class="direction-steps" id="direction-steps">
                <!-- ë°©í–¥ ì•ˆë‚´ ë‹¨ê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</div>
`;

// ë„¤ë¹„ê²Œì´ì…˜ CSS ìŠ¤íƒ€ì¼
const navigationCSS = `
/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.close-button {
    color: #aaa;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover {
    color: #555;
}

.modal-body {
    padding: 16px;
}

/* ë„¤ë¹„ê²Œì´ì…˜ ì˜µì…˜ ìŠ¤íƒ€ì¼ */
.navigation-options {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.nav-option-group, .nav-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-buttons {
    display: flex;
    gap: 8px;
}

.option-button {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f5f5f5;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.option-button.active {
    background-color: #c62917;
    color: white;
    border-color: #c62917;
}

.nav-select, .nav-input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.helper-text {
    font-size: 12px;
    color: #777;
    margin-top: 4px;
}

.quick-classroom-buttons {
    margin-top: 12px;
}

.quick-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
}

.quick-button {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f9f9f9;
    font-size: 12px;
    cursor: pointer;
}

.quick-button:hover {
    background-color: #f0f0f0;
}

.start-navigation {
    margin-top: 16px;
    padding: 12px;
    background-color: #c62917;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
}

.start-navigation:hover {
    background-color: #b52515;
}

/* ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ í™”ë©´ ìŠ¤íƒ€ì¼ */
.navigation-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 2500;
    display: flex;
    flex-direction: column;
}

.navigation-header {
    padding: 12px 16px;
    background-color: #c62917;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}

.navigation-header h3 {
    margin: 0;
}

.back-button, .navigation-header .close-button {
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.navigation-map {
    height: 40%;
    min-height: 250px;
    width: 100%;
    background-color: #f0f0f0;
}

.navigation-info {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.destination-info {
    display: flex;
    gap: 12px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eee;
}

.dest-icon {
    width: 40px;
    height: 40px;
    background-color: #f0f0f0;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
}

.dest-details {
    flex: 1;
}

.dest-name {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 4px;
}

.dest-desc {
    font-size: 14px;
    color: #666;
}

.route-info {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.route-summary {
    display: flex;
    justify-content: space-around;
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
}

.info-label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.info-value {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.direction-steps {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.direction-step {
    display: flex;
    gap: 12px;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
}

.step-icon {
    width: 30px;
    height: 30px;
    background-color: #f0f0f0;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
}

.step-details {
    flex: 1;
}

.step-instruction {
    font-size: 15px;
    margin-bottom: 4px;
}

.step-distance {
    font-size: 13px;
    color: #666;
}
`;

// ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ë° ë³€ìˆ˜ë“¤
let navigationActive = false;
let currentNavigationType = 'building'; // 'building' ë˜ëŠ” 'classroom'
let selectedBuildingId = '';
let inputClassroomNumber = '';
let selectedStartPoint = 'current';
let transportMode = 'walking'; // 'walking' ë˜ëŠ” 'shuttle'
let navigationMapObject = null;
let navigationPath = null;
let navigationMarkers = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë‹¬ ë° ìŠ¤íƒ€ì¼ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
    // ìŠ¤íƒ€ì¼ ì¶”ê°€
    const styleElement = document.createElement('style');
    styleElement.textContent = navigationCSS;
    document.head.appendChild(styleElement);
    
    // ëª¨ë‹¬ ì¶”ê°€
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = navigationModalHTML;
    document.body.appendChild(modalContainer);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ê°€ì´ë“œ ì¶”ê°€ (ìˆ¨ê²¨ì§„ ìƒíƒœ)
    const guideContainer = document.createElement('div');
    guideContainer.innerHTML = navigationGuideHTML;
    guideContainer.style.display = 'none';
    document.body.appendChild(guideContainer);
    
    // ê±´ë¬¼ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì±„ìš°ê¸°
    populateBuildingOptions();
    populateStartPointOptions();
});

// ê¸¸ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
function openNavigationModal(buildingId = '') {
    const modal = document.getElementById('navigation-modal');
    if (!modal) return;
    
    // íŠ¹ì • ê±´ë¬¼ì´ ì „ë‹¬ë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ê±´ë¬¼ ì„ íƒ
    if (buildingId) {
        selectedBuildingId = buildingId;
        const buildingSelect = document.getElementById('building-select');
        if (buildingSelect) {
            buildingSelect.value = buildingId;
        }
    }
    
    modal.style.display = 'block';
}

// ê¸¸ì°¾ê¸° ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
function closeNavigationModal() {
    const modal = document.getElementById('navigation-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ë„¤ë¹„ê²Œì´ì…˜ íƒ€ì… ì„¤ì • (ê±´ë¬¼ ë˜ëŠ” ê°•ì˜ì‹¤)
function setNavigationType(type) {
    currentNavigationType = type;
    
    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    const buildingBtn = document.getElementById('building-option');
    const classroomBtn = document.getElementById('classroom-option');
    
    if (buildingBtn && classroomBtn) {
        if (type === 'building') {
            buildingBtn.classList.add('active');
            classroomBtn.classList.remove('active');
            document.getElementById('building-selection').style.display = 'flex';
            document.getElementById('classroom-input').style.display = 'none';
        } else {
            buildingBtn.classList.remove('active');
            classroomBtn.classList.add('active');
            document.getElementById('building-selection').style.display = 'none';
            document.getElementById('classroom-input').style.display = 'flex';
        }
    }
}

// ê±´ë¬¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì±„ìš°ê¸°
function populateBuildingOptions() {
    const buildingSelect = document.getElementById('building-select');
    if (!buildingSelect) return;
    
    // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ì˜µì…˜ì€ ìœ ì§€)
    while (buildingSelect.options.length > 1) {
        buildingSelect.remove(1);
    }
    
    // ê±´ë¬¼ ë°ì´í„°ì—ì„œ ì˜µì…˜ ì¶”ê°€
    buildingData.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        buildingSelect.appendChild(option);
    });
    
    // ê±´ë¬¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    buildingSelect.addEventListener('change', function() {
        selectedBuildingId = this.value;
    });
}

// ì¶œë°œì§€ ì˜µì…˜ ì±„ìš°ê¸°
function populateStartPointOptions() {
    const startPointSelect = document.getElementById('start-point');
    if (!startPointSelect) return;
    
    // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ì˜µì…˜ì€ ìœ ì§€)
    while (startPointSelect.options.length > 1) {
        startPointSelect.remove(1);
    }
    
    // ê±´ë¬¼ ë°ì´í„°ì—ì„œ ì˜µì…˜ ì¶”ê°€
    buildingData.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        startPointSelect.appendChild(option);
    });
    
    // ì¶œë°œì§€ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    startPointSelect.addEventListener('change', function() {
        selectedStartPoint = this.value;
    });
}

// ìì£¼ ì°¾ëŠ” ê°•ì˜ì‹¤ ë²„íŠ¼ í´ë¦­ ì‹œ ê°•ì˜ì‹¤ ë²ˆí˜¸ ì„¤ì •
function setClassroom(classroomNumber) {
    const classroomInput = document.getElementById('classroom-number');
    if (classroomInput) {
        classroomInput.value = classroomNumber;
        inputClassroomNumber = classroomNumber;
    }
}

// ì´ë™ ë°©ì‹ ì„¤ì • (ë„ë³´ ë˜ëŠ” ì…”í‹€ë²„ìŠ¤)
function setTransportMode(mode) {
    transportMode = mode;
    
    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    const modeButtons = document.querySelectorAll('.nav-input-group:nth-child(4) .option-button');
    modeButtons.forEach(button => {
        if ((mode === 'walking' && button.textContent === 'ë„ë³´') || 
            (mode === 'shuttle' && button.textContent === 'ì…”í‹€ë²„ìŠ¤')) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

// ê¸¸ì°¾ê¸° ì‹œì‘í•˜ê¸°
function startNavigation() {
    let destinationName = '';
    let destinationDesc = '';
    let destinationCoords = null;
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìœ í˜•ì— ë”°ë¼ ëª©ì ì§€ ì •ë³´ ì„¤ì •
    if (currentNavigationType === 'building') {
        // ê±´ë¬¼ ì„ íƒ í™•ì¸
        if (!selectedBuildingId) {
            alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ì„ íƒëœ ê±´ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const selectedBuilding = buildingData.find(b => b.id === selectedBuildingId);
        if (!selectedBuilding) {
            alert('ì„ íƒí•œ ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        destinationName = selectedBuilding.name;
        destinationDesc = selectedBuilding.description;
        destinationCoords = selectedBuilding.position;
    } else {
        // ê°•ì˜ì‹¤ ì…ë ¥ í™•ì¸
        const classroomInput = document.getElementById('classroom-number');
        inputClassroomNumber = classroomInput ? classroomInput.value.trim() : '';
        
        if (!inputClassroomNumber) {
            alert('ê°•ì˜ì‹¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ê°•ì˜ì‹¤ í˜•ì‹ ë¶„ì„ (ê±´ë¬¼-í˜¸ìˆ˜)
        const parts = inputClassroomNumber.split('-');
        if (parts.length !== 2) {
            alert('ê°•ì˜ì‹¤ ë²ˆí˜¸ë¥¼ ê±´ë¬¼-í˜¸ìˆ˜ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ê³µí•™1ê´€-101)');
            return;
        }
        
        const buildingName = parts[0];
        const roomNumber = parts[1];
        
        // ê±´ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const relatedBuilding = buildingData.find(b => 
            b.name === buildingName || b.id === buildingName
        );
        
        if (!relatedBuilding) {
            alert(`'${buildingName}' ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        destinationName = `${buildingName} ${roomNumber}í˜¸`;
        destinationDesc = `${relatedBuilding.description} ${roomNumber}í˜¸`;
        destinationCoords = relatedBuilding.position;
    }
    
    // ì¶œë°œì§€ ì„ íƒ í™•ì¸
    let startCoords = null;
    
    if (selectedStartPoint === 'current') {
        // í˜„ì¬ ìœ„ì¹˜ (ì„ì˜ë¡œ ìº í¼ìŠ¤ ì…êµ¬ ì¢Œí‘œ ì„¤ì •)
        startCoords = { lat: 37.39576992475254, lng: 126.90812350405056 }; // ìº í¼ìŠ¤ ì…êµ¬(ë¬¸í™”1ê´€) ì¢Œí‘œë¡œ ê°€ì •
    } else {
        // ì„ íƒëœ ê±´ë¬¼ ì¢Œí‘œ
        const startBuilding = buildingData.find(b => b.id === selectedStartPoint);
        if (!startBuilding) {
            alert('ì„ íƒí•œ ì¶œë°œì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        startCoords = startBuilding.position;
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeNavigationModal();
    
    // ë„¤ë¹„ê²Œì´ì…˜ í™”ë©´ í‘œì‹œ
    showNavigationGuide(startCoords, destinationCoords, destinationName, destinationDesc);
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ í™”ë©´ í‘œì‹œ ë° ì„¤ì •
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // ë„¤ë¹„ê²Œì´ì…˜ ì»¨í…Œì´ë„ˆ í‘œì‹œ
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // ëª©ì ì§€ ì •ë³´ ì„¤ì •
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // ê²½ë¡œ ì •ë³´ëŠ” ê°œë°œ ì¤‘ìœ¼ë¡œ í‘œì‹œ
    document.getElementById('total-distance').textContent = '500m';
    document.getElementById('total-time').textContent = '7ë¶„';
    
    // ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
    createNavigationSteps(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
    initNavigationMap(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ í™œì„±í™”
    navigationActive = true;
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // ê¸°ì¡´ ë‹¨ê³„ ì´ˆê¸°í™”
    stepsContainer.innerHTML = '';
    
    // ìƒ˜í”Œ ë‹¨ê³„ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ê²½ë¡œ ê³„ì‚° API ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
    const steps = [
        { instruction: 'ì¶œë°œì§€ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 50m ì´ë™', icon: 'â¡ï¸', distance: '50m' },
        { instruction: 'ê³µí•™ê´€ ë°©í–¥ìœ¼ë¡œ ì§ì§„', icon: 'â¬†ï¸', distance: '100m' },
        { instruction: 'íš¡ë‹¨ë³´ë„ë¥¼ ê±´ë„ˆ ì™¼ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¬…ï¸', distance: '80m' },
        { instruction: 'í•™ìƒë³µì§€ì„¼í„° ì•ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¡ï¸', distance: '120m' },
        { instruction: 'ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤', icon: 'ğŸ', distance: '' }
    ];
    
    // ë‹¨ê³„ ìš”ì†Œ ìƒì„±
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
function initNavigationMap(startCoords, destCoords) {
    // ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ í™•ì¸
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì§€ë„ ì»¨í…Œì´ë„ˆ
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // ì§€ë„ ìƒì„±
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // ì¶œë°œì§€ ë§ˆì»¤ ìƒì„±
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // ëª©ì ì§€ ë§ˆì»¤ ìƒì„±
    const destMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(20, 20),
            anchor: new naver.maps.Point(10, 10)
        }
    });
    navigationMarkers.push(destMarker);
    
    // ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸° (ì„ì˜ì˜ ê²½ë¡œ)
    createRoutePath(startCoords, destCoords);
    
    // ê²½ë¡œê°€ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ì˜ì—­ ì¡°ì •
    const bounds = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    );
    navigationMapObject.fitBounds(bounds, {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50
    });
}

// ê²½ë¡œ ë¼ì¸ ìƒì„± (ì‹¤ì œë¡œëŠ” ê²½ë¡œ API ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
function createRoutePath(startCoords, destCoords) {
    // ì„ì˜ì˜ ì¤‘ê°„ ì§€ì  ìƒì„± (ì‹¤ì œë¡œëŠ” ê²½ë¡œ API ì‘ë‹µì—ì„œ ë°›ì•„ì•¼ í•¨)
    const midPoint1 = {
        lat: (startCoords.lat * 0.7 + destCoords.lat * 0.3),
        lng: (startCoords.lng * 0.7 + destCoords.lng * 0.3)
    };
    
    const midPoint2 = {
        lat: (startCoords.lat * 0.3 + destCoords.lat * 0.7),
        lng: (startCoords.lng * 0.3 + destCoords.lng * 0.7)
    };
    
    // ê²½ë¡œ ì¢Œí‘œ ë°°ì—´
    const pathCoords = [
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(midPoint1.lat, midPoint1.lng),
        new naver.maps.LatLng(midPoint2.lat, midPoint2.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    ];
    
    // ê²½ë¡œ ë¼ì¸ ìƒì„±
    navigationPath = new naver.maps.Polyline({
        path: pathCoords,
        strokeColor: '#c62917',
        strokeWeight: 5,
        strokeOpacity: 0.8,
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        map: navigationMapObject
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ì·¨ì†Œ ë° ì¢…ë£Œ
function cancelNavigation() {
    // ë„¤ë¹„ê²Œì´ì…˜ í™”ë©´ ìˆ¨ê¹€
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'none';
    }
    
    // ì§€ë„ ë° ë§ˆì»¤, ê²½ë¡œ ì´ˆê¸°í™”
    if (navigationMapObject) {
        // ë§ˆì»¤ ì œê±°
        navigationMarkers.forEach(marker => marker.setMap(null));
        navigationMarkers = [];
        
        // ê²½ë¡œ ì œê±°
        if (navigationPath) {
            navigationPath.setMap(null);
            navigationPath = null;
        }
        
        navigationMapObject = null;
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ë¹„í™œì„±í™”
    navigationActive = false;
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // ê¸°ì¡´ ë‹¨ê³„ ì´ˆê¸°í™”
    stepsContainer.innerHTML = '';
    
    // ìƒ˜í”Œ ë‹¨ê³„ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ê²½ë¡œ ê³„ì‚° API ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
    const steps = [
        { instruction: 'ì¶œë°œì§€ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 50m ì´ë™', icon: 'â¡ï¸', distance: '50m' },
        { instruction: 'ê³µí•™ê´€ ë°©í–¥ìœ¼ë¡œ ì§ì§„', icon: 'â¬†ï¸', distance: '100m' },
        { instruction: 'íš¡ë‹¨ë³´ë„ë¥¼ ê±´ë„ˆ ì™¼ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¬…ï¸', distance: '80m' },
        { instruction: 'í•™ìƒë³µì§€ì„¼í„° ì•ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¡ï¸', distance: '120m' },
        { instruction: 'ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤', icon: 'ğŸ', distance: '' }
    ];
    
    // ë‹¨ê³„ ìš”ì†Œ ìƒì„±
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
function initNavigationMap(startCoords, destCoords) {
    // ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ í™•ì¸
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì§€ë„ ì»¨í…Œì´ë„ˆ
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // ì§€ë„ ìƒì„±
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // ì¶œë°œì§€ ë§ˆì»¤ ìƒì„±
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // ëª©ì ì§€ ë§ˆì»¤ ìƒì„±
    const destMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(20, 20),
            anchor: new naver.maps.Point(10, 10)
        }
    });
    navigationMarkers.push(destMarker);
    
    // ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸° (ì„ì˜ì˜ ê²½ë¡œ)
    createRoutePath(startCoords, destCoords);
    
    // ê²½ë¡œê°€ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ì˜ì—­ ì¡°ì •
    const bounds = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    );
    navigationMapObject.fitBounds(bounds, {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ í™”ë©´ í‘œì‹œ ë° ì„¤ì •
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // ë„¤ë¹„ê²Œì´ì…˜ ì»¨í…Œì´ë„ˆ í‘œì‹œ
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // ëª©ì ì§€ ì •ë³´ ì„¤ì •
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // ê²½ë¡œ ì •ë³´ ì„¤ì •
    // ì‹¤ì œ ê±°ë¦¬ ê³„ì‚° (ì§ì„  ê±°ë¦¬ëŠ” ì„ì˜ë¡œ ê³„ì‚°, ì‹¤ì œë¡œëŠ” ê²½ë¡œ APIì—ì„œ ì •í™•í•œ ê°’ í•„ìš”)
    const distance = calculateDistance(startCoords, destCoords);
    const distanceText = distance < 1000 ? `${Math.round(distance)}m` : `${(distance / 1000).toFixed(1)}km`;
    
    // ê±·ëŠ” ì†ë„ë¥¼ ë¶„ë‹¹ 80më¡œ ê°€ì •
    const timeInMinutes = Math.ceil(distance / 80);
    const timeText = `${timeInMinutes}ë¶„`;
    
    document.getElementById('total-distance').textContent = distanceText;
    document.getElementById('total-time').textContent = timeText;
    
    // ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
    createNavigationSteps(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
    initNavigationMap(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ í™œì„±í™”
    navigationActive = true;
}

// ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
function calculateDistance(point1, point2) {
    // ì§€êµ¬ ë°˜ê²½ (ë¯¸í„°)
    const R = 6371000;
    
    // ìœ„ë„, ê²½ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
    const lat1 = point1.lat * Math.PI / 180;
    const lat2 = point2.lat * Math.PI / 180;
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLon = (point2.lng - point1.lng) * Math.PI / 180;
    
    // Haversine ê³µì‹ ì ìš©
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// ê±´ë¬¼ ê¸¸ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ í•¨ìˆ˜ ìˆ˜ì • - ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ ë° ìƒˆ ê¸°ëŠ¥ ì—°ê²°
function navigateToBuilding(buildingId, event) {
    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì¤‘ë‹¨
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // ê¸¸ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
    openNavigationModal(buildingId);
}

// ê¸¸ì°¾ê¸° ì‹œì‘ ê¸°ëŠ¥
function startNavigation() {
    let destinationName = '';
    let destinationDesc = '';
    let destinationCoords = null;
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìœ í˜•ì— ë”°ë¼ ëª©ì ì§€ ì •ë³´ ì„¤ì •
    if (currentNavigationType === 'building') {
        // ê±´ë¬¼ ì„ íƒ í™•ì¸
        if (!selectedBuildingId) {
            alert('ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ì„ íƒëœ ê±´ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const selectedBuilding = buildingData.find(b => b.id === selectedBuildingId);
        if (!selectedBuilding) {
            alert('ì„ íƒí•œ ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        destinationName = selectedBuilding.name;
        destinationDesc = selectedBuilding.description;
        destinationCoords = selectedBuilding.position;
    } else {
        // ê°•ì˜ì‹¤ ì…ë ¥ í™•ì¸
        const classroomInput = document.getElementById('classroom-number');
        inputClassroomNumber = classroomInput ? classroomInput.value.trim() : '';
        
        if (!inputClassroomNumber) {
            alert('ê°•ì˜ì‹¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ê°•ì˜ì‹¤ í˜•ì‹ ë¶„ì„ (ê±´ë¬¼-í˜¸ìˆ˜)
        const parts = inputClassroomNumber.split('-');
        if (parts.length !== 2) {
            alert('ê°•ì˜ì‹¤ ë²ˆí˜¸ë¥¼ ê±´ë¬¼-í˜¸ìˆ˜ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ê³µí•™1ê´€-101)');
            return;
        }
        
        const buildingName = parts[0];
        const roomNumber = parts[1];
        
        // ê±´ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const relatedBuilding = buildingData.find(b => 
            b.name === buildingName || b.id === buildingName
        );
        
        if (!relatedBuilding) {
            alert(`'${buildingName}' ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        destinationName = `${buildingName} ${roomNumber}í˜¸`;
        destinationDesc = `${relatedBuilding.description} ${roomNumber}í˜¸`;
        destinationCoords = relatedBuilding.position;
    }
    
    // ì¶œë°œì§€ ì„ íƒ í™•ì¸
    let startCoords = null;
    
    if (selectedStartPoint === 'current') {
        // í˜„ì¬ ìœ„ì¹˜ (ì„ì˜ë¡œ ìº í¼ìŠ¤ ì…êµ¬ ì¢Œí‘œ ì„¤ì •)
        startCoords = { lat: 37.39576992475254, lng: 126.90812350405056 }; // ìº í¼ìŠ¤ ì…êµ¬(ë¬¸í™”1ê´€) ì¢Œí‘œë¡œ ê°€ì •
    } else {
        // ì„ íƒëœ ê±´ë¬¼ ì¢Œí‘œ
        const startBuilding = buildingData.find(b => b.id === selectedStartPoint);
        if (!startBuilding) {
            alert('ì„ íƒí•œ ì¶œë°œì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        startCoords = startBuilding.position;
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeNavigationModal();
    
    // ë„¤ë¹„ê²Œì´ì…˜ í™”ë©´ í‘œì‹œ
    showNavigationGuide(startCoords, destinationCoords, destinationName, destinationDesc);
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ í™”ë©´ í‘œì‹œ ë° ì„¤ì •
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // ë„¤ë¹„ê²Œì´ì…˜ ì»¨í…Œì´ë„ˆ í‘œì‹œ
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // ëª©ì ì§€ ì •ë³´ ì„¤ì •
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // ê²½ë¡œ ì •ë³´ ì„¤ì •
    // ì‹¤ì œ ê±°ë¦¬ ê³„ì‚° (ì§ì„  ê±°ë¦¬ëŠ” ì„ì˜ë¡œ ê³„ì‚°, ì‹¤ì œë¡œëŠ” ê²½ë¡œ APIì—ì„œ ì •í™•í•œ ê°’ í•„ìš”)
    const distance = calculateDistance(startCoords, destCoords);
    const distanceText = distance < 1000 ? `${Math.round(distance)}m` : `${(distance / 1000).toFixed(1)}km`;
    
    // ê±·ëŠ” ì†ë„ë¥¼ ë¶„ë‹¹ 80më¡œ ê°€ì •
    const timeInMinutes = Math.ceil(distance / 80);
    const timeText = `${timeInMinutes}ë¶„`;
    
    document.getElementById('total-distance').textContent = distanceText;
    document.getElementById('total-time').textContent = timeText;
    
    // ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
    createNavigationSteps(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
    initNavigationMap(startCoords, destCoords);
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ í™œì„±í™”
    navigationActive = true;
}

// ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
function calculateDistance(point1, point2) {
    // ì§€êµ¬ ë°˜ê²½ (ë¯¸í„°)
    const R = 6371000;
    
    // ìœ„ë„, ê²½ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
    const lat1 = point1.lat * Math.PI / 180;
    const lat2 = point2.lat * Math.PI / 180;
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLon = (point2.lng - point1.lng) * Math.PI / 180;
    
    // Haversine ê³µì‹ ì ìš©
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // ê¸°ì¡´ ë‹¨ê³„ ì´ˆê¸°í™”
    stepsContainer.innerHTML = '';
    
    // ìƒ˜í”Œ ë‹¨ê³„ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ê²½ë¡œ ê³„ì‚° API ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
    const steps = [
        { instruction: 'ì¶œë°œì§€ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 50m ì´ë™', icon: 'â¡ï¸', distance: '50m' },
        { instruction: 'ê³µí•™ê´€ ë°©í–¥ìœ¼ë¡œ ì§ì§„', icon: 'â¬†ï¸', distance: '100m' },
        { instruction: 'íš¡ë‹¨ë³´ë„ë¥¼ ê±´ë„ˆ ì™¼ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¬…ï¸', distance: '80m' },
        { instruction: 'í•™ìƒë³µì§€ì„¼í„° ì•ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™', icon: 'â¡ï¸', distance: '120m' },
        { instruction: 'ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤', icon: 'ğŸ', distance: '' }
    ];
    
    // ë‹¨ê³„ ìš”ì†Œ ìƒì„±
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ë§µ ì´ˆê¸°í™”
function initNavigationMap(startCoords, destCoords) {
    // ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ í™•ì¸
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì§€ë„ ì»¨í…Œì´ë„ˆ
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // ì§€ë„ ìƒì„±
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // ì¶œë°œì§€ ë§ˆì»¤ ìƒì„±
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // ëª©ì ì§€ ë§ˆì»¤ ìƒì„±
const destMarker = new naver.maps.Marker({
    position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
    map: navigationMapObject,
    icon: {
        content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
        size: new naver.maps.Size(20, 20),
        anchor: new naver.maps.Point(10, 10)
    }
});
navigationMarkers.push(destMarker);

// ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸° (ì„ì˜ì˜ ê²½ë¡œ)
createRoutePath(startCoords, destCoords);

// ê²½ë¡œê°€ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ì˜ì—­ ì¡°ì •
const bounds = new naver.maps.LatLngBounds(
    new naver.maps.LatLng(startCoords.lat, startCoords.lng),
    new naver.maps.LatLng(destCoords.lat, destCoords.lng)
);
navigationMapObject.fitBounds(bounds, {
    top: 50,
    right: 50,
    bottom: 50,
    left: 50
});
}

// ê²½ë¡œ ë¼ì¸ ìƒì„± (ì‹¤ì œë¡œëŠ” ê²½ë¡œ API ê²°ê³¼ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨)
function createRoutePath(startCoords, destCoords) {
    // ì„ì˜ì˜ ì¤‘ê°„ ì§€ì  ìƒì„± (ì‹¤ì œë¡œëŠ” ê²½ë¡œ API ì‘ë‹µì—ì„œ ë°›ì•„ì•¼ í•¨)
    const midPoint1 = {
        lat: (startCoords.lat * 0.7 + destCoords.lat * 0.3),
        lng: (startCoords.lng * 0.7 + destCoords.lng * 0.3)
    };
    
    const midPoint2 = {
        lat: (startCoords.lat * 0.3 + destCoords.lat * 0.7),
        lng: (startCoords.lng * 0.3 + destCoords.lng * 0.7)
    };
    
    // ê²½ë¡œ ì¢Œí‘œ ë°°ì—´
    const pathCoords = [
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(midPoint1.lat, midPoint1.lng),
        new naver.maps.LatLng(midPoint2.lat, midPoint2.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    ];
    
    // ê²½ë¡œ ë¼ì¸ ìƒì„±
    navigationPath = new naver.maps.Polyline({
        path: pathCoords,
        strokeColor: '#c62917',
        strokeWeight: 5,
        strokeOpacity: 0.8,
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        map: navigationMapObject
    });
}

// ë„¤ë¹„ê²Œì´ì…˜ ì·¨ì†Œ ë° ì¢…ë£Œ
function cancelNavigation() {
    // ë„¤ë¹„ê²Œì´ì…˜ í™”ë©´ ìˆ¨ê¹€
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'none';
    }
    
    // ì§€ë„ ë° ë§ˆì»¤, ê²½ë¡œ ì´ˆê¸°í™”
    if (navigationMapObject) {
        // ë§ˆì»¤ ì œê±°
        navigationMarkers.forEach(marker => marker.setMap(null));
        navigationMarkers = [];
        
        // ê²½ë¡œ ì œê±°
        if (navigationPath) {
            navigationPath.setMap(null);
            navigationPath = null;
        }
        
        navigationMapObject = null;
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ë¹„í™œì„±í™”
    navigationActive = false;
}

// ê±´ë¬¼ ê¸¸ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ í•¨ìˆ˜ ìˆ˜ì • - ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ ë° ìƒˆ ê¸°ëŠ¥ ì—°ê²°
function navigateToBuilding(buildingId, event) {
    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì¤‘ë‹¨
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // ê¸¸ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
    openNavigationModal(buildingId);
}

// ê¸¸ì°¾ê¸° ë²„íŠ¼ ì„¤ì • í•¨ìˆ˜
function setupBuildingNavButtons() {
    // ëª¨ë“  building-nav-button ìš”ì†Œ ì„ íƒ
    const navButtons = document.querySelectorAll('.building-list .building-nav-button');
    
    navButtons.forEach(button => {
        // ì´ë¯¸ ì´ë²¤íŠ¸ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (button.dataset.navigationSet === 'true') return;
        
        // ê¸°ì¡´ onclick ì†ì„± ì œê±°
        button.removeAttribute('onclick');
        
        // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        button.addEventListener('click', function(event) {
            // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            event.preventDefault();
            event.stopPropagation();
            
            // ë¶€ëª¨ ìš”ì†Œì—ì„œ ê±´ë¬¼ ID ì°¾ê¸°
            const buildingItem = this.closest('.building-item');
            if (!buildingItem) return;
            
            const buildingName = buildingItem.querySelector('.building-name').textContent;
            // ê±´ë¬¼ ì´ë¦„ìœ¼ë¡œ ê±´ë¬¼ ID ì°¾ê¸°
            const building = buildingData.find(b => b.name === buildingName);
            
            if (building) {
                // ê¸¸ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
                openNavigationModal(building.id);
            }
        });
        
        // ì„¤ì • ì™„ë£Œ í‘œì‹œ
        button.dataset.navigationSet = 'true';
    });
}

// í¸ì˜ì‹œì„¤ í•­ëª©ì—ë„ ê¸¸ì°¾ê¸° ê¸°ëŠ¥ ì¶”ê°€
function enhanceFacilityItems() {
    const facilityItems = document.querySelectorAll('.facility-item');
    
    facilityItems.forEach(item => {
        // ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ìœ ì§€í•˜ë©´ì„œ ê¸¸ì°¾ê¸° ë²„íŠ¼ ì¶”ê°€
        const facilityName = item.querySelector('.facility-name').textContent;
        
        // ì°¾ê¸° ìœ„í•œ ID íƒìƒ‰
        const facility = facilityData.find(f => f.name === facilityName);
        
        if (facility) {
            // ì´ë¯¸ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if (item.querySelector('.building-nav-button')) return;
            
            // ê¸¸ì°¾ê¸° ë²„íŠ¼ ì¶”ê°€
            const navButton = document.createElement('div');
            navButton.className = 'building-nav-button';
            navButton.innerHTML = '<span>ê¸¸ì°¾ê¸°</span><span>ğŸ§­</span>';
            
            // ê¸°ì¡´ ì •ë³´ ì»¨í…Œì´ë„ˆì— flex ë ˆì´ì•„ì›ƒ ì¶”ê°€
            const infoContainer = item.querySelector('.facility-info');
            infoContainer.style.display = 'flex';
            infoContainer.style.justifyContent = 'space-between';
            infoContainer.style.alignItems = 'center';
            
            // ì •ë³´ ë˜í¼ ìƒì„±
            const infoWrapper = document.createElement('div');
            
            // ê¸°ì¡´ ë‚´ìš© ì´ë™
            const name = infoContainer.querySelector('.facility-name');
            const location = infoContainer.querySelector('.facility-location');
            
            // ì •ë³´ ìš”ì†Œë¥¼ ë˜í¼ë¡œ ì´ë™
            if (name && location) {
                infoWrapper.appendChild(name.cloneNode(true));
                infoWrapper.appendChild(location.cloneNode(true));
                
                // ê¸°ì¡´ ë‚´ìš© ì œê±° í›„ ìƒˆ êµ¬ì¡° ì¶”ê°€
                infoContainer.innerHTML = '';
                infoContainer.appendChild(infoWrapper);
                infoContainer.appendChild(navButton);
                
                // ê¸¸ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                navButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // ê´€ë ¨ ê±´ë¬¼ IDë¡œ ê¸¸ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
                    openNavigationModal(facility.relatedBuilding);
                });
            }
        }
    });
}

// í˜ì´ì§€ ì´ˆê¸°í™” ì‹œ í†µí•© ì½”ë“œ
document.addEventListener('DOMContentLoaded', function() {
    // ê¸°ì¡´ í˜ì´ì§€ ì´ˆê¸°í™” í›„ ë„¤ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥ ì¶”ê°€
    setTimeout(function() {
        // ê¸¸ì°¾ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
        setupBuildingNavButtons();
        
        // í¸ì˜ì‹œì„¤ í•­ëª©ì— ê¸¸ì°¾ê¸° ë²„íŠ¼ ì¶”ê°€
        enhanceFacilityItems();
    }, 1000);
});

// íƒ­ ì „í™˜ ì‹œ ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì¬ì„¤ì •
const originalSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
    // ì›ë˜ í•¨ìˆ˜ í˜¸ì¶œ
    originalSwitchTab(tabName);
    
    // ì‹œì„¤ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì¬ì„¤ì •
    if (tabName === 'facility') {
        setTimeout(function() {
            setupBuildingNavButtons();
            enhanceFacilityItems();
        }, 500);
    }
};

// ì´ˆê¸°í™” ìë™ ì‹¤í–‰
setTimeout(function() {
    console.log('ê¸¸ì°¾ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™” ì¤‘...');
    setupBuildingNavButtons();
    enhanceFacilityItems();
}, 1500);
</script>
</body>
</html>