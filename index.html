// 네비게이션 관련 함수 추가

// 길찾기 모달 HTML 
const navigationModalHTML = `
<div id="navigation-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>길찾기</h3>
            <span class="close-button" onclick="closeNavigationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="navigation-options">
                <div class="nav-option-group">
                    <label>찾는 장소 유형</label>
                    <div class="option-buttons">
                        <button id="building-option" class="option-button active" onclick="setNavigationType('building')">건물</button>
                        <button id="classroom-option" class="option-button" onclick="setNavigationType('classroom')">강의실</button>
                    </div>
                </div>
                
                <!-- 건물 선택 드롭다운 -->
                <div id="building-selection" class="nav-input-group">
                    <label for="building-select">건물 선택</label>
                    <select id="building-select" class="nav-select">
                        <option value="">건물을 선택하세요</option>
                        <!-- 건물 옵션들은 자바스크립트로 동적 추가 -->
                    </select>
                </div>
                
                <!-- 강의실 입력 폼 (기본적으로 숨김) -->
                <div id="classroom-input" class="nav-input-group" style="display: none;">
                    <label for="classroom-number">강의실 번호</label>
                    <input type="text" id="classroom-number" class="nav-input" placeholder="예: 3-101">
                    <div class="helper-text">건물-호수 형식으로 입력하세요 (예: 공학1관-101)</div>
                    
                    <!-- 자주 찾는 강의실 버튼들 -->
                    <div class="quick-classroom-buttons">
                        <div class="helper-text">자주 찾는 강의실:</div>
                        <div class="quick-buttons">
                            <button class="quick-button" onclick="setClassroom('공학1관-101')">공학1관-101</button>
                            <button class="quick-button" onclick="setClassroom('문화1관-203')">문화1관-203</button>
                            <button class="quick-button" onclick="setClassroom('도의관-301')">도의관-301</button>
                        </div>
                    </div>
                </div>
                
                <!-- 출발지 선택 (현재 위치 또는 다른 건물) -->
                <div class="nav-input-group">
                    <label for="start-point">출발지</label>
                    <select id="start-point" class="nav-select">
                        <option value="current">현재 위치</option>
                        <!-- 출발지 옵션들은 자바스크립트로 동적 추가 -->
                    </select>
                </div>
                
                <!-- 이동 방식 선택 -->
                <div class="nav-input-group">
                    <label>이동 방식</label>
                    <div class="option-buttons">
                        <button class="option-button active" onclick="setTransportMode('walking')">도보</button>
                        <button class="option-button" onclick="setTransportMode('shuttle')">셔틀버스</button>
                    </div>
                </div>
                
                <!-- 시작 버튼 -->
                <button id="start-navigation-btn" class="start-navigation" onclick="startNavigation()">길찾기 시작</button>
            </div>
        </div>
    </div>
</div>
`;

// 네비게이션 안내 화면 HTML
const navigationGuideHTML = `
<div id="navigation-guide" class="navigation-container">
    <div class="navigation-header">
        <button class="back-button" onclick="cancelNavigation()">
            <span>&larr;</span> 뒤로
        </button>
        <h3 id="navigation-title">길찾기</h3>
        <button class="close-button" onclick="cancelNavigation()">
            <span>&times;</span>
        </button>
    </div>
    
    <div class="navigation-map" id="navigation-map">
        <!-- 네이버 지도가 여기에 표시됩니다 -->
    </div>
    
    <div class="navigation-info">
        <div class="destination-info">
            <div class="dest-icon">🏫</div>
            <div class="dest-details">
                <div id="dest-name" class="dest-name">목적지 이름</div>
                <div id="dest-desc" class="dest-desc">목적지 정보</div>
            </div>
        </div>
        
        <div class="route-info">
            <div class="route-summary">
                <div class="route-distance">
                    <span class="info-label">총 거리</span>
                    <span id="total-distance" class="info-value">0m</span>
                </div>
                <div class="route-time">
                    <span class="info-label">예상 소요시간</span>
                    <span id="total-time" class="info-value">0분</span>
                </div>
            </div>
            
            <div class="direction-steps" id="direction-steps">
                <!-- 방향 안내 단계가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>
</div>
`;

// 네비게이션 CSS 스타일
const navigationCSS = `
/* 모달 스타일 */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.close-button {
    color: #aaa;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover {
    color: #555;
}

.modal-body {
    padding: 16px;
}

/* 네비게이션 옵션 스타일 */
.navigation-options {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.nav-option-group, .nav-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-buttons {
    display: flex;
    gap: 8px;
}

.option-button {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f5f5f5;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.option-button.active {
    background-color: #c62917;
    color: white;
    border-color: #c62917;
}

.nav-select, .nav-input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.helper-text {
    font-size: 12px;
    color: #777;
    margin-top: 4px;
}

.quick-classroom-buttons {
    margin-top: 12px;
}

.quick-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
}

.quick-button {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f9f9f9;
    font-size: 12px;
    cursor: pointer;
}

.quick-button:hover {
    background-color: #f0f0f0;
}

.start-navigation {
    margin-top: 16px;
    padding: 12px;
    background-color: #c62917;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
}

.start-navigation:hover {
    background-color: #b52515;
}

/* 네비게이션 안내 화면 스타일 */
.navigation-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 2500;
    display: flex;
    flex-direction: column;
}

.navigation-header {
    padding: 12px 16px;
    background-color: #c62917;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}

.navigation-header h3 {
    margin: 0;
}

.back-button, .navigation-header .close-button {
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.navigation-map {
    height: 40%;
    min-height: 250px;
    width: 100%;
    background-color: #f0f0f0;
}

.navigation-info {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.destination-info {
    display: flex;
    gap: 12px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eee;
}

.dest-icon {
    width: 40px;
    height: 40px;
    background-color: #f0f0f0;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
}

.dest-details {
    flex: 1;
}

.dest-name {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 4px;
}

.dest-desc {
    font-size: 14px;
    color: #666;
}

.route-info {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.route-summary {
    display: flex;
    justify-content: space-around;
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
}

.info-label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.info-value {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.direction-steps {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.direction-step {
    display: flex;
    gap: 12px;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
}

.step-icon {
    width: 30px;
    height: 30px;
    background-color: #f0f0f0;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
}

.step-details {
    flex: 1;
}

.step-instruction {
    font-size: 15px;
    margin-bottom: 4px;
}

.step-distance {
    font-size: 13px;
    color: #666;
}
`;

// 네비게이션 상태 및 변수들
let navigationActive = false;
let currentNavigationType = 'building'; // 'building' 또는 'classroom'
let selectedBuildingId = '';
let inputClassroomNumber = '';
let selectedStartPoint = 'current';
let transportMode = 'walking'; // 'walking' 또는 'shuttle'
let navigationMapObject = null;
let navigationPath = null;
let navigationMarkers = [];

// 페이지 로드 시 네비게이션 모달 및 스타일 추가
document.addEventListener('DOMContentLoaded', function() {
    // 스타일 추가
    const styleElement = document.createElement('style');
    styleElement.textContent = navigationCSS;
    document.head.appendChild(styleElement);
    
    // 모달 추가
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = navigationModalHTML;
    document.body.appendChild(modalContainer);
    
    // 네비게이션 가이드 추가 (숨겨진 상태)
    const guideContainer = document.createElement('div');
    guideContainer.innerHTML = navigationGuideHTML;
    guideContainer.style.display = 'none';
    document.body.appendChild(guideContainer);
    
    // 건물 드롭다운 옵션 채우기
    populateBuildingOptions();
    populateStartPointOptions();
});

// 길찾기 모달 열기 함수
function openNavigationModal(buildingId = '') {
    const modal = document.getElementById('navigation-modal');
    if (!modal) return;
    
    // 특정 건물이 전달되었다면 해당 건물 선택
    if (buildingId) {
        selectedBuildingId = buildingId;
        const buildingSelect = document.getElementById('building-select');
        if (buildingSelect) {
            buildingSelect.value = buildingId;
        }
    }
    
    modal.style.display = 'block';
}

// 길찾기 모달 닫기 함수
function closeNavigationModal() {
    const modal = document.getElementById('navigation-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 네비게이션 타입 설정 (건물 또는 강의실)
function setNavigationType(type) {
    currentNavigationType = type;
    
    // 버튼 활성화 상태 변경
    const buildingBtn = document.getElementById('building-option');
    const classroomBtn = document.getElementById('classroom-option');
    
    if (buildingBtn && classroomBtn) {
        if (type === 'building') {
            buildingBtn.classList.add('active');
            classroomBtn.classList.remove('active');
            document.getElementById('building-selection').style.display = 'flex';
            document.getElementById('classroom-input').style.display = 'none';
        } else {
            buildingBtn.classList.remove('active');
            classroomBtn.classList.add('active');
            document.getElementById('building-selection').style.display = 'none';
            document.getElementById('classroom-input').style.display = 'flex';
        }
    }
}

// 건물 선택 드롭다운 옵션 채우기
function populateBuildingOptions() {
    const buildingSelect = document.getElementById('building-select');
    if (!buildingSelect) return;
    
    // 기존 옵션 초기화 (첫 번째 옵션은 유지)
    while (buildingSelect.options.length > 1) {
        buildingSelect.remove(1);
    }
    
    // 건물 데이터에서 옵션 추가
    buildingData.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        buildingSelect.appendChild(option);
    });
    
    // 건물 선택 이벤트 리스너
    buildingSelect.addEventListener('change', function() {
        selectedBuildingId = this.value;
    });
}

// 출발지 옵션 채우기
function populateStartPointOptions() {
    const startPointSelect = document.getElementById('start-point');
    if (!startPointSelect) return;
    
    // 기존 옵션 초기화 (첫 번째 옵션은 유지)
    while (startPointSelect.options.length > 1) {
        startPointSelect.remove(1);
    }
    
    // 건물 데이터에서 옵션 추가
    buildingData.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        startPointSelect.appendChild(option);
    });
    
    // 출발지 선택 이벤트 리스너
    startPointSelect.addEventListener('change', function() {
        selectedStartPoint = this.value;
    });
}

// 자주 찾는 강의실 버튼 클릭 시 강의실 번호 설정
function setClassroom(classroomNumber) {
    const classroomInput = document.getElementById('classroom-number');
    if (classroomInput) {
        classroomInput.value = classroomNumber;
        inputClassroomNumber = classroomNumber;
    }
}

// 이동 방식 설정 (도보 또는 셔틀버스)
function setTransportMode(mode) {
    transportMode = mode;
    
    // 버튼 활성화 상태 변경
    const modeButtons = document.querySelectorAll('.nav-input-group:nth-child(4) .option-button');
    modeButtons.forEach(button => {
        if ((mode === 'walking' && button.textContent === '도보') || 
            (mode === 'shuttle' && button.textContent === '셔틀버스')) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

// 길찾기 시작하기
function startNavigation() {
    let destinationName = '';
    let destinationDesc = '';
    let destinationCoords = null;
    
    // 네비게이션 유형에 따라 목적지 정보 설정
    if (currentNavigationType === 'building') {
        // 건물 선택 확인
        if (!selectedBuildingId) {
            alert('건물을 선택해주세요.');
            return;
        }
        
        // 선택된 건물 정보 가져오기
        const selectedBuilding = buildingData.find(b => b.id === selectedBuildingId);
        if (!selectedBuilding) {
            alert('선택한 건물 정보를 찾을 수 없습니다.');
            return;
        }
        
        destinationName = selectedBuilding.name;
        destinationDesc = selectedBuilding.description;
        destinationCoords = selectedBuilding.position;
    } else {
        // 강의실 입력 확인
        const classroomInput = document.getElementById('classroom-number');
        inputClassroomNumber = classroomInput ? classroomInput.value.trim() : '';
        
        if (!inputClassroomNumber) {
            alert('강의실 번호를 입력해주세요.');
            return;
        }
        
        // 강의실 형식 분석 (건물-호수)
        const parts = inputClassroomNumber.split('-');
        if (parts.length !== 2) {
            alert('강의실 번호를 건물-호수 형식으로 입력해주세요. (예: 공학1관-101)');
            return;
        }
        
        const buildingName = parts[0];
        const roomNumber = parts[1];
        
        // 건물 정보 가져오기
        const relatedBuilding = buildingData.find(b => 
            b.name === buildingName || b.id === buildingName
        );
        
        if (!relatedBuilding) {
            alert(`'${buildingName}' 건물 정보를 찾을 수 없습니다.`);
            return;
        }
        
        destinationName = `${buildingName} ${roomNumber}호`;
        destinationDesc = `${relatedBuilding.description} ${roomNumber}호`;
        destinationCoords = relatedBuilding.position;
    }
    
    // 출발지 선택 확인
    let startCoords = null;
    
    if (selectedStartPoint === 'current') {
        // 현재 위치 (임의로 캠퍼스 입구 좌표 설정)
        startCoords = { lat: 37.39576992475254, lng: 126.90812350405056 }; // 캠퍼스 입구(문화1관) 좌표로 가정
    } else {
        // 선택된 건물 좌표
        const startBuilding = buildingData.find(b => b.id === selectedStartPoint);
        if (!startBuilding) {
            alert('선택한 출발지 정보를 찾을 수 없습니다.');
            return;
        }
        startCoords = startBuilding.position;
    }
    
    // 모달 닫기
    closeNavigationModal();
    
    // 네비게이션 화면 표시
    showNavigationGuide(startCoords, destinationCoords, destinationName, destinationDesc);
}

// 네비게이션 안내 화면 표시 및 설정
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // 네비게이션 컨테이너 표시
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // 목적지 정보 설정
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // 경로 정보는 개발 중으로 표시
    document.getElementById('total-distance').textContent = '500m';
    document.getElementById('total-time').textContent = '7분';
    
    // 안내 단계 생성
    createNavigationSteps(startCoords, destCoords);
    
    // 네비게이션 맵 초기화
    initNavigationMap(startCoords, destCoords);
    
    // 네비게이션 상태 활성화
    navigationActive = true;
}

// 네비게이션 안내 단계 생성
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // 기존 단계 초기화
    stepsContainer.innerHTML = '';
    
    // 샘플 단계 데이터 (실제로는 경로 계산 API 결과를 사용해야 함)
    const steps = [
        { instruction: '출발지에서 오른쪽으로 50m 이동', icon: '➡️', distance: '50m' },
        { instruction: '공학관 방향으로 직진', icon: '⬆️', distance: '100m' },
        { instruction: '횡단보도를 건너 왼쪽으로 이동', icon: '⬅️', distance: '80m' },
        { instruction: '학생복지센터 앞에서 오른쪽으로 이동', icon: '➡️', distance: '120m' },
        { instruction: '목적지에 도착했습니다', icon: '🏁', distance: '' }
    ];
    
    // 단계 요소 생성
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// 네비게이션 맵 초기화
function initNavigationMap(startCoords, destCoords) {
    // 네이버 지도 API 로드 확인
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('네이버 지도 API가 로드되지 않았습니다.');
        return;
    }
    
    // 지도 컨테이너
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // 지도 생성
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // 출발지 마커 생성
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // 목적지 마커 생성
    const destMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(20, 20),
            anchor: new naver.maps.Point(10, 10)
        }
    });
    navigationMarkers.push(destMarker);
    
    // 경로 라인 그리기 (임의의 경로)
    createRoutePath(startCoords, destCoords);
    
    // 경로가 모두 보이도록 지도 영역 조정
    const bounds = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    );
    navigationMapObject.fitBounds(bounds, {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50
    });
}

// 경로 라인 생성 (실제로는 경로 API 결과를 사용해야 함)
function createRoutePath(startCoords, destCoords) {
    // 임의의 중간 지점 생성 (실제로는 경로 API 응답에서 받아야 함)
    const midPoint1 = {
        lat: (startCoords.lat * 0.7 + destCoords.lat * 0.3),
        lng: (startCoords.lng * 0.7 + destCoords.lng * 0.3)
    };
    
    const midPoint2 = {
        lat: (startCoords.lat * 0.3 + destCoords.lat * 0.7),
        lng: (startCoords.lng * 0.3 + destCoords.lng * 0.7)
    };
    
    // 경로 좌표 배열
    const pathCoords = [
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(midPoint1.lat, midPoint1.lng),
        new naver.maps.LatLng(midPoint2.lat, midPoint2.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    ];
    
    // 경로 라인 생성
    navigationPath = new naver.maps.Polyline({
        path: pathCoords,
        strokeColor: '#c62917',
        strokeWeight: 5,
        strokeOpacity: 0.8,
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        map: navigationMapObject
    });
}

// 네비게이션 취소 및 종료
function cancelNavigation() {
    // 네비게이션 화면 숨김
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'none';
    }
    
    // 지도 및 마커, 경로 초기화
    if (navigationMapObject) {
        // 마커 제거
        navigationMarkers.forEach(marker => marker.setMap(null));
        navigationMarkers = [];
        
        // 경로 제거
        if (navigationPath) {
            navigationPath.setMap(null);
            navigationPath = null;
        }
        
        navigationMapObject = null;
    }
    
    // 네비게이션 상태 비활성화
    navigationActive = false;
}

// 네비게이션 안내 단계 생성
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // 기존 단계 초기화
    stepsContainer.innerHTML = '';
    
    // 샘플 단계 데이터 (실제로는 경로 계산 API 결과를 사용해야 함)
    const steps = [
        { instruction: '출발지에서 오른쪽으로 50m 이동', icon: '➡️', distance: '50m' },
        { instruction: '공학관 방향으로 직진', icon: '⬆️', distance: '100m' },
        { instruction: '횡단보도를 건너 왼쪽으로 이동', icon: '⬅️', distance: '80m' },
        { instruction: '학생복지센터 앞에서 오른쪽으로 이동', icon: '➡️', distance: '120m' },
        { instruction: '목적지에 도착했습니다', icon: '🏁', distance: '' }
    ];
    
    // 단계 요소 생성
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// 네비게이션 맵 초기화
function initNavigationMap(startCoords, destCoords) {
    // 네이버 지도 API 로드 확인
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('네이버 지도 API가 로드되지 않았습니다.');
        return;
    }
    
    // 지도 컨테이너
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // 지도 생성
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // 출발지 마커 생성
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // 목적지 마커 생성
    const destMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(20, 20),
            anchor: new naver.maps.Point(10, 10)
        }
    });
    navigationMarkers.push(destMarker);
    
    // 경로 라인 그리기 (임의의 경로)
    createRoutePath(startCoords, destCoords);
    
    // 경로가 모두 보이도록 지도 영역 조정
    const bounds = new naver.maps.LatLngBounds(
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    );
    navigationMapObject.fitBounds(bounds, {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50
    });
}

// 네비게이션 안내 화면 표시 및 설정
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // 네비게이션 컨테이너 표시
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // 목적지 정보 설정
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // 경로 정보 설정
    // 실제 거리 계산 (직선 거리는 임의로 계산, 실제로는 경로 API에서 정확한 값 필요)
    const distance = calculateDistance(startCoords, destCoords);
    const distanceText = distance < 1000 ? `${Math.round(distance)}m` : `${(distance / 1000).toFixed(1)}km`;
    
    // 걷는 속도를 분당 80m로 가정
    const timeInMinutes = Math.ceil(distance / 80);
    const timeText = `${timeInMinutes}분`;
    
    document.getElementById('total-distance').textContent = distanceText;
    document.getElementById('total-time').textContent = timeText;
    
    // 안내 단계 생성
    createNavigationSteps(startCoords, destCoords);
    
    // 네비게이션 맵 초기화
    initNavigationMap(startCoords, destCoords);
    
    // 네비게이션 상태 활성화
    navigationActive = true;
}

// 두 지점 간의 거리 계산 (미터 단위)
function calculateDistance(point1, point2) {
    // 지구 반경 (미터)
    const R = 6371000;
    
    // 위도, 경도를 라디안으로 변환
    const lat1 = point1.lat * Math.PI / 180;
    const lat2 = point2.lat * Math.PI / 180;
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLon = (point2.lng - point1.lng) * Math.PI / 180;
    
    // Haversine 공식 적용
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// 건물 길찾기 버튼 클릭 처리 함수 수정 - 이벤트 버블링 방지 및 새 기능 연결
function navigateToBuilding(buildingId, event) {
    // 이벤트 버블링 중단
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // 길찾기 모달 열기
    openNavigationModal(buildingId);
}

// 길찾기 시작 기능
function startNavigation() {
    let destinationName = '';
    let destinationDesc = '';
    let destinationCoords = null;
    
    // 네비게이션 유형에 따라 목적지 정보 설정
    if (currentNavigationType === 'building') {
        // 건물 선택 확인
        if (!selectedBuildingId) {
            alert('건물을 선택해주세요.');
            return;
        }
        
        // 선택된 건물 정보 가져오기
        const selectedBuilding = buildingData.find(b => b.id === selectedBuildingId);
        if (!selectedBuilding) {
            alert('선택한 건물 정보를 찾을 수 없습니다.');
            return;
        }
        
        destinationName = selectedBuilding.name;
        destinationDesc = selectedBuilding.description;
        destinationCoords = selectedBuilding.position;
    } else {
        // 강의실 입력 확인
        const classroomInput = document.getElementById('classroom-number');
        inputClassroomNumber = classroomInput ? classroomInput.value.trim() : '';
        
        if (!inputClassroomNumber) {
            alert('강의실 번호를 입력해주세요.');
            return;
        }
        
        // 강의실 형식 분석 (건물-호수)
        const parts = inputClassroomNumber.split('-');
        if (parts.length !== 2) {
            alert('강의실 번호를 건물-호수 형식으로 입력해주세요. (예: 공학1관-101)');
            return;
        }
        
        const buildingName = parts[0];
        const roomNumber = parts[1];
        
        // 건물 정보 가져오기
        const relatedBuilding = buildingData.find(b => 
            b.name === buildingName || b.id === buildingName
        );
        
        if (!relatedBuilding) {
            alert(`'${buildingName}' 건물 정보를 찾을 수 없습니다.`);
            return;
        }
        
        destinationName = `${buildingName} ${roomNumber}호`;
        destinationDesc = `${relatedBuilding.description} ${roomNumber}호`;
        destinationCoords = relatedBuilding.position;
    }
    
    // 출발지 선택 확인
    let startCoords = null;
    
    if (selectedStartPoint === 'current') {
        // 현재 위치 (임의로 캠퍼스 입구 좌표 설정)
        startCoords = { lat: 37.39576992475254, lng: 126.90812350405056 }; // 캠퍼스 입구(문화1관) 좌표로 가정
    } else {
        // 선택된 건물 좌표
        const startBuilding = buildingData.find(b => b.id === selectedStartPoint);
        if (!startBuilding) {
            alert('선택한 출발지 정보를 찾을 수 없습니다.');
            return;
        }
        startCoords = startBuilding.position;
    }
    
    // 모달 닫기
    closeNavigationModal();
    
    // 네비게이션 화면 표시
    showNavigationGuide(startCoords, destinationCoords, destinationName, destinationDesc);
}

// 네비게이션 안내 화면 표시 및 설정
function showNavigationGuide(startCoords, destCoords, destName, destDesc) {
    // 네비게이션 컨테이너 표시
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'flex';
    }
    
    // 목적지 정보 설정
    document.getElementById('dest-name').textContent = destName;
    document.getElementById('dest-desc').textContent = destDesc;
    
    // 경로 정보 설정
    // 실제 거리 계산 (직선 거리는 임의로 계산, 실제로는 경로 API에서 정확한 값 필요)
    const distance = calculateDistance(startCoords, destCoords);
    const distanceText = distance < 1000 ? `${Math.round(distance)}m` : `${(distance / 1000).toFixed(1)}km`;
    
    // 걷는 속도를 분당 80m로 가정
    const timeInMinutes = Math.ceil(distance / 80);
    const timeText = `${timeInMinutes}분`;
    
    document.getElementById('total-distance').textContent = distanceText;
    document.getElementById('total-time').textContent = timeText;
    
    // 안내 단계 생성
    createNavigationSteps(startCoords, destCoords);
    
    // 네비게이션 맵 초기화
    initNavigationMap(startCoords, destCoords);
    
    // 네비게이션 상태 활성화
    navigationActive = true;
}

// 두 지점 간의 거리 계산 (미터 단위)
function calculateDistance(point1, point2) {
    // 지구 반경 (미터)
    const R = 6371000;
    
    // 위도, 경도를 라디안으로 변환
    const lat1 = point1.lat * Math.PI / 180;
    const lat2 = point2.lat * Math.PI / 180;
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLon = (point2.lng - point1.lng) * Math.PI / 180;
    
    // Haversine 공식 적용
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// 네비게이션 안내 단계 생성
function createNavigationSteps(startCoords, destCoords) {
    const stepsContainer = document.getElementById('direction-steps');
    if (!stepsContainer) return;
    
    // 기존 단계 초기화
    stepsContainer.innerHTML = '';
    
    // 샘플 단계 데이터 (실제로는 경로 계산 API 결과를 사용해야 함)
    const steps = [
        { instruction: '출발지에서 오른쪽으로 50m 이동', icon: '➡️', distance: '50m' },
        { instruction: '공학관 방향으로 직진', icon: '⬆️', distance: '100m' },
        { instruction: '횡단보도를 건너 왼쪽으로 이동', icon: '⬅️', distance: '80m' },
        { instruction: '학생복지센터 앞에서 오른쪽으로 이동', icon: '➡️', distance: '120m' },
        { instruction: '목적지에 도착했습니다', icon: '🏁', distance: '' }
    ];
    
    // 단계 요소 생성
    steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.className = 'direction-step';
        
        stepElement.innerHTML = `
            <div class="step-icon">${step.icon}</div>
            <div class="step-details">
                <div class="step-instruction">${step.instruction}</div>
                ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
            </div>
        `;
        
        stepsContainer.appendChild(stepElement);
    });
}

// 네비게이션 맵 초기화
function initNavigationMap(startCoords, destCoords) {
    // 네이버 지도 API 로드 확인
    if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
        console.error('네이버 지도 API가 로드되지 않았습니다.');
        return;
    }
    
    // 지도 컨테이너
    const mapContainer = document.getElementById('navigation-map');
    if (!mapContainer) return;
    
    // 지도 생성
    navigationMapObject = new naver.maps.Map(mapContainer, {
        center: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
        zoom: 17,
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT
        }
    });
    
    // 출발지 마커 생성
    const startMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        map: navigationMapObject,
        icon: {
            content: '<div style="background-color: #2196F3; width: 15px; height: 15px; border-radius: 50%;"></div>',
            size: new naver.maps.Size(15, 15),
            anchor: new naver.maps.Point(7.5, 7.5)
        }
    });
    navigationMarkers.push(startMarker);
    
    // 목적지 마커 생성
const destMarker = new naver.maps.Marker({
    position: new naver.maps.LatLng(destCoords.lat, destCoords.lng),
    map: navigationMapObject,
    icon: {
        content: '<div style="background-color: #c62917; width: 20px; height: 20px; border-radius: 50%;"></div>',
        size: new naver.maps.Size(20, 20),
        anchor: new naver.maps.Point(10, 10)
    }
});
navigationMarkers.push(destMarker);

// 경로 라인 그리기 (임의의 경로)
createRoutePath(startCoords, destCoords);

// 경로가 모두 보이도록 지도 영역 조정
const bounds = new naver.maps.LatLngBounds(
    new naver.maps.LatLng(startCoords.lat, startCoords.lng),
    new naver.maps.LatLng(destCoords.lat, destCoords.lng)
);
navigationMapObject.fitBounds(bounds, {
    top: 50,
    right: 50,
    bottom: 50,
    left: 50
});
}

// 경로 라인 생성 (실제로는 경로 API 결과를 사용해야 함)
function createRoutePath(startCoords, destCoords) {
    // 임의의 중간 지점 생성 (실제로는 경로 API 응답에서 받아야 함)
    const midPoint1 = {
        lat: (startCoords.lat * 0.7 + destCoords.lat * 0.3),
        lng: (startCoords.lng * 0.7 + destCoords.lng * 0.3)
    };
    
    const midPoint2 = {
        lat: (startCoords.lat * 0.3 + destCoords.lat * 0.7),
        lng: (startCoords.lng * 0.3 + destCoords.lng * 0.7)
    };
    
    // 경로 좌표 배열
    const pathCoords = [
        new naver.maps.LatLng(startCoords.lat, startCoords.lng),
        new naver.maps.LatLng(midPoint1.lat, midPoint1.lng),
        new naver.maps.LatLng(midPoint2.lat, midPoint2.lng),
        new naver.maps.LatLng(destCoords.lat, destCoords.lng)
    ];
    
    // 경로 라인 생성
    navigationPath = new naver.maps.Polyline({
        path: pathCoords,
        strokeColor: '#c62917',
        strokeWeight: 5,
        strokeOpacity: 0.8,
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        map: navigationMapObject
    });
}

// 네비게이션 취소 및 종료
function cancelNavigation() {
    // 네비게이션 화면 숨김
    const navGuide = document.querySelector('#navigation-guide');
    if (navGuide) {
        navGuide.style.display = 'none';
    }
    
    // 지도 및 마커, 경로 초기화
    if (navigationMapObject) {
        // 마커 제거
        navigationMarkers.forEach(marker => marker.setMap(null));
        navigationMarkers = [];
        
        // 경로 제거
        if (navigationPath) {
            navigationPath.setMap(null);
            navigationPath = null;
        }
        
        navigationMapObject = null;
    }
    
    // 네비게이션 상태 비활성화
    navigationActive = false;
}

// 건물 길찾기 버튼 클릭 처리 함수 수정 - 이벤트 버블링 방지 및 새 기능 연결
function navigateToBuilding(buildingId, event) {
    // 이벤트 버블링 중단
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // 길찾기 모달 열기
    openNavigationModal(buildingId);
}

// 길찾기 버튼 설정 함수
function setupBuildingNavButtons() {
    // 모든 building-nav-button 요소 선택
    const navButtons = document.querySelectorAll('.building-list .building-nav-button');
    
    navButtons.forEach(button => {
        // 이미 이벤트가 설정되어 있는지 확인
        if (button.dataset.navigationSet === 'true') return;
        
        // 기존 onclick 속성 제거
        button.removeAttribute('onclick');
        
        // 새 이벤트 리스너 추가
        button.addEventListener('click', function(event) {
            // 이벤트 버블링 방지
            event.preventDefault();
            event.stopPropagation();
            
            // 부모 요소에서 건물 ID 찾기
            const buildingItem = this.closest('.building-item');
            if (!buildingItem) return;
            
            const buildingName = buildingItem.querySelector('.building-name').textContent;
            // 건물 이름으로 건물 ID 찾기
            const building = buildingData.find(b => b.name === buildingName);
            
            if (building) {
                // 길찾기 모달 열기
                openNavigationModal(building.id);
            }
        });
        
        // 설정 완료 표시
        button.dataset.navigationSet = 'true';
    });
}

// 편의시설 항목에도 길찾기 기능 추가
function enhanceFacilityItems() {
    const facilityItems = document.querySelectorAll('.facility-item');
    
    facilityItems.forEach(item => {
        // 기존 레이아웃 유지하면서 길찾기 버튼 추가
        const facilityName = item.querySelector('.facility-name').textContent;
        
        // 찾기 위한 ID 탐색
        const facility = facilityData.find(f => f.name === facilityName);
        
        if (facility) {
            // 이미 버튼이 있는지 확인
            if (item.querySelector('.building-nav-button')) return;
            
            // 길찾기 버튼 추가
            const navButton = document.createElement('div');
            navButton.className = 'building-nav-button';
            navButton.innerHTML = '<span>길찾기</span><span>🧭</span>';
            
            // 기존 정보 컨테이너에 flex 레이아웃 추가
            const infoContainer = item.querySelector('.facility-info');
            infoContainer.style.display = 'flex';
            infoContainer.style.justifyContent = 'space-between';
            infoContainer.style.alignItems = 'center';
            
            // 정보 래퍼 생성
            const infoWrapper = document.createElement('div');
            
            // 기존 내용 이동
            const name = infoContainer.querySelector('.facility-name');
            const location = infoContainer.querySelector('.facility-location');
            
            // 정보 요소를 래퍼로 이동
            if (name && location) {
                infoWrapper.appendChild(name.cloneNode(true));
                infoWrapper.appendChild(location.cloneNode(true));
                
                // 기존 내용 제거 후 새 구조 추가
                infoContainer.innerHTML = '';
                infoContainer.appendChild(infoWrapper);
                infoContainer.appendChild(navButton);
                
                // 길찾기 버튼 클릭 이벤트
                navButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // 관련 건물 ID로 길찾기 모달 열기
                    openNavigationModal(facility.relatedBuilding);
                });
            }
        }
    });
}

// 페이지 초기화 시 통합 코드
document.addEventListener('DOMContentLoaded', function() {
    // 기존 페이지 초기화 후 네비게이션 기능 추가
    setTimeout(function() {
        // 길찾기 버튼 이벤트 핸들러 설정
        setupBuildingNavButtons();
        
        // 편의시설 항목에 길찾기 버튼 추가
        enhanceFacilityItems();
    }, 1000);
});

// 탭 전환 시 내비게이션 버튼 재설정
const originalSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
    // 원래 함수 호출
    originalSwitchTab(tabName);
    
    // 시설 탭으로 전환 시 내비게이션 버튼 재설정
    if (tabName === 'facility') {
        setTimeout(function() {
            setupBuildingNavButtons();
            enhanceFacilityItems();
        }, 500);
    }
};

// 초기화 자동 실행
setTimeout(function() {
    console.log('길찾기 기능 초기화 중...');
    setupBuildingNavButtons();
    enhanceFacilityItems();
}, 1500);
</script>
</body>
</html>